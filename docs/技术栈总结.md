# 技术栈总结

> 本文档已与当前工程（pnpm workspace 单仓多包）对齐，描述实际使用的技术栈与项目结构。

## 核心技术栈

### 语言与运行时

- **TypeScript 5.x + Node.js 20+**
- 包管理：pnpm（推荐）或 npm
- 构建工具：tsup 或 tsc

### Phase 1 技术栈（MVP）

```
表现层：
  - CLI: Commander.js + Inquirer.js + Chalk + Ora + cli-table3 + boxen

应用层/领域层：
  - TypeScript（严格模式）
  - 模块结构：pnpm workspace 单仓多包
  - packages/core：领域层（8 大模块）+ 依赖注入（tsyringe）
  - packages/infrastructure：存储/LLM/配置/日志
  - packages/types：共享类型与 Zod Schema
  - packages/cli：表现层 CLI 入口

基础设施层：
  - 存储：内存 + JSON 文件（fs-extra）
  - LLM：Deepseek（openai 兼容）、Claude（@anthropic-ai/sdk）官方 SDK
  - 配置：JSON（原生）+ YAML（js-yaml）
  - 校验：Zod（TypeScript-first）
  - 环境变量：dotenv
  - 日志：winston
  - 依赖注入：tsyringe + reflect-metadata（Phase 1 已采用）
```

### Phase 2-3 扩展技术栈

```
表现层：
  - Web: Next.js（前端）+ Nest.js 或 Express（后端）

性能优化：
  - 并发：Promise.all/Promise.allSettled
  - 缓存：node-cache 或 Redis
  - 队列：Bull 或 BullMQ

存储升级：
  - better-sqlite3（SQLite）
  - MongoDB（mongoose）

依赖注入：
  - 已在 Phase 1 使用 tsyringe；扩展可选 InversifyJS
```

## 核心依赖包（Phase 1）

### 必需依赖（按包分布）

- **根/工具链**：typescript ^5.x、@types/node ^20.x、tsup ^8.x、eslint、prettier、husky、lint-staged、commitlint
- **@star-rail/types**：zod ^3.x
- **@star-rail/infrastructure**：dotenv、js-yaml、zod、fs-extra、winston、@anthropic-ai/sdk、openai、tsyringe、reflect-metadata
- **@star-rail/core**：@star-rail/types、@star-rail/infrastructure、tsyringe、reflect-metadata、fs-extra；测试：jest、ts-jest
- **@star-rail/cli**：commander、inquirer、chalk、ora、cli-table3、boxen、@star-rail/types、@star-rail/infrastructure、@star-rail/core

说明：LLM 调用通过各厂商官方 SDK，未使用 axios/node-fetch。

### LLM SDK 说明

| 服务商   | SDK 包名               | 说明                          |
| -------- | ---------------------- | ----------------------------- |
| Deepseek | `openai`               | 兼容 OpenAI SDK，修改 baseURL |
| 豆包     | 官方 SDK（待确认包名） | 字节跳动官方 SDK              |
| Claude   | `@anthropic-ai/sdk`    | Anthropic 官方 SDK            |

## 项目结构

当前为 **pnpm workspace 单仓多包** 结构（与文档原“单包 src/”描述不同，以本结构为准）：

```
StarRailReplicationPlan/
├── packages/
│   ├── types/                 # 共享类型与 Zod Schema
│   │   └── src/
│   ├── infrastructure/       # 基础设施层
│   │   └── src/
│   │       ├── config/        # 配置加载、环境变量
│   │       ├── storage/       # 存储适配器（JSON 文件）
│   │       ├── llm/           # LLM Provider（Claude/Deepseek）
│   │       ├── logging/       # winston 日志
│   │       └── error/
│   ├── core/                  # 领域层 + 应用编排
│   │   └── src/
│   │       ├── input-parser/     # 用户输入解析
│   │       ├── world-engine/     # 世界引擎
│   │       ├── vision-manager/   # 信息与视野管理
│   │       ├── character-state/  # 人物状态与演化
│   │       ├── character-agent/  # 角色 Agent
│   │       ├── story-orchestrator/ # 剧情推进编排
│   │       ├── anchor-evaluation/  # 锚点与对比评估
│   │       ├── export-import/   # 导出/导入
│   │       └── container.ts     # tsyringe 依赖注入
│   └── cli/                  # 表现层 CLI
│       └── src/
│           ├── commands/
│           ├── services/
│           └── ui/
├── config/                   # 配置文件（与文档一致）
│   ├── characters/
│   ├── triggers/
│   └── scenes/
├── docs/
├── package.json
├── pnpm-workspace.yaml
├── tsconfig.json
├── .env.example
└── README.md
```

## 开发工具链

### 代码质量

- ESLint + Prettier（代码格式化）
- Husky + lint-staged（Git hooks）
- Commitlint（Conventional Commits）
- Jest（单元测试，core 包）

### 开发体验

- tsup（构建与 dts，各包独立 build）
- pnpm -r build / pnpm -r dev（按包构建或监听）

## 下一步行动

### 1. 初始化项目

```bash
# 创建项目
mkdir StarRailReplicationPlan
cd StarRailReplicationPlan

# 初始化 package.json
pnpm init

# 安装 TypeScript
pnpm add -D typescript @types/node tsx tsup

# 初始化 tsconfig.json
pnpm tsc --init
```

### 2. 安装核心依赖

```bash
# CLI 工具
pnpm add commander inquirer chalk ora

# 工具库
pnpm add fs-extra dotenv axios js-yaml zod

# LLM SDK
pnpm add @anthropic-ai/sdk openai

# 类型定义
pnpm add -D @types/inquirer @types/fs-extra @types/js-yaml
```

### 3. 项目结构说明

当前工程已采用 pnpm workspace，包结构见上文「项目结构」。新增领域模块时在 `packages/core/src/` 下添加目录并在 `packages/core/src/index.ts` 导出。

### 4. 配置 TypeScript

编辑 `tsconfig.json`：

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 5. 开始开发

按照 WBS 任务分解表，从 Phase 1 的 P1-INF-01 开始：

- 定义核心数据模型（Character/WorldState/Information）
- 使用 TypeScript interface 或 Zod schema

## 技术决策理由

### 为什么选择 TypeScript？

1. **团队熟悉度**：你熟悉 TypeScript/JavaScript，无需学习新语言
2. **开发效率**：直接上手，Phase 1 可节省 2-4 周学习时间
3. **类型安全**：TypeScript 类型系统比 Python 更强大
4. **LLM SDK 完全够用**：Deepseek/豆包/Claude 都有官方 Node.js SDK
5. **技术栈统一**：Phase 2-3 做 Web 时，前后端都是 TypeScript
6. **生态成熟**：CLI、Web、数据处理工具链都很完善

### 与 Python 的对比

| 维度     | TypeScript      | Python             |
| -------- | --------------- | ------------------ |
| 学习成本 | ✅ 无需学习     | ❌ 需要 2-4 周     |
| 开发效率 | ✅ 直接上手     | ❌ 边学边做        |
| 类型安全 | ✅ 原生强类型   | ⚠️ 需要 type hints |
| LLM SDK  | ✅ 都有官方支持 | ✅ 都有官方支持    |
| Web 开发 | ✅ 前后端统一   | ❌ 技术栈割裂      |

## 参考资源

### 官方文档

- [TypeScript 官方文档](https://www.typescriptlang.org/)
- [Node.js 官方文档](https://nodejs.org/)
- [Commander.js](https://github.com/tj/commander.js)
- [Inquirer.js](https://github.com/SBoudrias/Inquirer.js)
- [Zod](https://zod.dev/)

### LLM SDK

- [Anthropic Claude SDK](https://github.com/anthropics/anthropic-sdk-typescript)
- [OpenAI SDK](https://github.com/openai/openai-node)
- [Deepseek API 文档](https://platform.deepseek.com/docs)
- [豆包 API 文档](https://www.volcengine.com/docs/82379)
