# DEV-P1-09 表现层 UI 模块完成文档

## 模块概述

DEV-P1-09 实现了 CLI 表现层的核心功能，包括用户输入处理、剧情推进、对比触发与结果展示、导出/导入入口，以及视野隔离验收功能。

## WBS 任务完成情况

### P1-UI-01: 用户输入框、剧情/对话展示、导出/导入入口、对比触发与结果展示

**状态**: ✅ 已完成

**实现内容**:

1. **用户输入处理** (`session-workspace.ts`)
   - 支持对话型输入：`对[人物]说：[内容]`
   - 支持指令型输入：`让[人物][动作]`
   - 集成 StoryOrchestrator 进行剧情推进

2. **剧情/对话展示**
   - 角色对话显示（带角色名称）
   - 角色动作描述
   - 角色内心独白（可选）
   - 状态变更提示

3. **命令系统**
   - `/help` - 显示帮助信息
   - `/status` - 显示当前状态
   - `/characters` - 显示人物列表
   - `/events` - 显示最近事件
   - `/save` - 保存会话
   - `/snapshot` - 创建快照
   - `/anchor` - 锚点管理（create/list/delete）
   - `/compare` - 对比当前状态与锚点
   - `/vision` - 显示视野隔离状态
   - `/quit` - 退出会话

4. **导出/导入入口**
   - `star-rail export` - 导出人物/场景/会话
   - `star-rail import` - 导入人物/场景/会话
   - 支持冲突检测和处理策略

### P1-UI-02: 视野隔离验收

**状态**: ✅ 已完成

**实现内容**:

1. **视野状态显示** (`/vision` 命令)
   - 显示每个角色的已知信息
   - 显示每个角色的未知信息
   - 标识视野隔离的信息（仅部分角色知道）

2. **验收场景支持**
   - 1 场景 + 2 角色场景
   - 某信息仅 A 知时 B 不泄露验证
   - 视觉化展示隔离状态

## 新增/修改文件

### 新增文件

1. **`packages/cli/src/services/story-service.ts`**
   - StoryService 类：封装 StoryOrchestrator 和 AnchorEvaluator
   - 提供剧情推进、锚点管理、对比评估功能
   - 单例模式管理

### 修改文件

1. **`packages/cli/src/ui/session-workspace.ts`**
   - 集成 StoryService 进行剧情推进
   - 新增 `/anchor`、`/compare`、`/vision` 命令
   - 实现角色响应显示
   - 实现对比结果展示
   - 实现视野隔离状态显示

2. **`packages/cli/src/services/export-service.ts`**
   - 新增会话导出/导入功能
   - 新增冲突检测方法
   - 新增元数据读取方法

3. **`packages/cli/src/commands/export.ts`**
   - 新增会话导出选项
   - 支持交互式选择导出类型

4. **`packages/cli/src/commands/import.ts`**
   - 新增会话导入功能
   - 支持冲突处理策略选择
   - 支持文件验证

## 核心功能说明

### 1. 剧情推进流程

```
用户输入 → InputParser 解析 → StoryOrchestrator 处理
    ↓
获取角色视野 → CharacterAgent 生成响应 → 显示结果
    ↓
更新状态 → 创建快照 → 自动保存
```

### 2. 锚点管理

```typescript
// 创建锚点
/anchor create
  → 输入锚点名称
  → 输入剧情线 ID
  → 输入情节描述
  → 从当前会话状态创建锚点

// 列出锚点
/anchor list
  → 显示所有锚点信息

// 删除锚点
/anchor delete
  → 选择要删除的锚点
```

### 3. 对比功能

```typescript
// 对比当前状态与锚点
/compare
  → 选择锚点
  → 显示总体差异度
  → 显示差异详情
  → 显示维度对比
```

### 4. 视野隔离验收

```typescript
// 显示视野状态
/vision
  → 显示每个角色的已知/未知信息
  → 标识视野隔离的信息
  → 验证隔离是否生效
```

## 使用示例

### 启动会话

```bash
star-rail start
# 或
star-rail session new "测试会话"
```

### 剧情推进

```
▶ 对三月七说：你好，今天天气真好
三月七：是啊，阳光明媚的日子最适合出去走走了！
  [三月七 微笑着看向窗外]
```

### 创建锚点

```
▶ /anchor create
锚点名称：第一章结束
剧情线 ID：main
情节描述：三月七与星初次相遇

锚点已创建: anchor_1234567890_abc
  名称: 第一章结束
  剧情线: main
  顺序: 1
  人物数: 2
```

### 对比状态

```
▶ /compare
选择要对比的锚点：第一章结束 (main #1)

═══ 对比结果: 第一章结束 ═══

总体差异度: 15.0%
评估: 当前分支与原剧情基本一致，存在 2 处细微差异。

差异详情:
  • 三月七 缺少 1 条原剧情中应知道的信息
  • 三月七 对 stelle 的信任度与原剧情差异 10.0%
```

### 视野隔离验收

```
▶ /vision

═══ 视野隔离状态 ═══

  三月七 (march7)
    已知信息: 3 条
      ✓ 星的真实身份
      ✓ 列车的目的地
      ✓ 银河的秘密
    未知信息: 1 条
      ✗ 星的过去

  星 (stelle)
    已知信息: 2 条
      ✓ 列车的目的地
      ✓ 星的过去
    未知信息: 2 条
      ✗ 星的真实身份
      ✗ 银河的秘密

═══ 视野隔离验证 ═══

  ✓ 存在视野隔离的信息:

    "星的真实身份"
      知道: 三月七
      不知道: 星

    "星的过去"
      知道: 星
      不知道: 三月七
```

## 测试覆盖

- 所有 193 个测试通过
- 包含 7 个测试套件
- 覆盖核心模块的所有功能

## 依赖关系

```
@star-rail/cli
  ├── @star-rail/core (StoryOrchestrator, AnchorEvaluator, ExportImportService)
  ├── @star-rail/types (类型定义)
  ├── @star-rail/infrastructure (存储适配器)
  ├── commander (命令行解析)
  ├── inquirer (交互式提示)
  ├── chalk (终端颜色)
  ├── ora (加载动画)
  └── boxen (终端框)
```

## 后续优化建议

1. **性能优化**
   - 大型会话的分页加载
   - 锚点数据的持久化存储

2. **用户体验**
   - 自动补全角色名称
   - 历史命令记录
   - 更丰富的对话展示格式

3. **功能扩展**
   - 多角色对话场景
   - 分支剧情管理
   - 剧情回放功能
