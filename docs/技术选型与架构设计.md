# 《星穹铁道剧情复现计划》技术选型与架构设计

本文档与《概要设计》分层对应，用于记录技术选型与架构设计结论。**多轮对话逐步补充**：未确定项标「待定」，待下一轮讨论后更新。

---

## 一、选型总览

### 1.1 部署形态

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 运行形态 | 本地单机 / 本地+服务端 / 纯服务端 | **本地单机**（Phase 1-2）；Phase 3 后逐步部署到服务端 |
| 多用户 | 是否需要多用户同时使用、数据隔离方式 | Phase 1-2 单用户；服务端部署时按会话 ID 隔离 |

### 1.2 技术栈一览（与概要设计分层对应）

| 层次 | 概要设计对应 | 技术选型 | 备注 |
|------|----------------|----------|------|
| 表现层 | Presentation | **待定**（CLI / Web 框架等） | 见 §2.1；建议 Phase 1 先用 CLI |
| 应用层 | Application | **TypeScript + Node.js 20+** | 见 §2.2；团队熟悉、开发效率高 |
| 领域层 | Domain | 与应用层同语言；显式模块边界 | 见 §2.2 |
| 基础设施层 | Infrastructure | 内存+JSON 文件；多家 LLM API | 见 §2.3 |

### 1.3 是否使用 LLM 及形态

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 对话/行动生成 | 是否使用大模型（API 调用）还是规则/模板先行 | **使用 LLM API**（Phase 1-3 优先）；Phase 3 后引入自定义规则与混合方案 |
| LLM 服务商 | 第三方 API 选型 | **多家 API 支持**：Deepseek、豆包（字节）、Anthropic Claude；统一接口抽象 |
| 本地模型 | 是否自建部署 | Phase 3 后可选引入（如 Qwen/Llama）；当前预留接口 |
| 成本控制 | 缓存、降级、规则替代 | Phase 3 后优化；当前优先功能验证 |

---

## 二、各层技术选型

### 2.1 表现层

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 形态 | CLI / Web（若 Web：框架如 React/Vue、是否 SSR） | **Phase 1: CLI**（Commander.js + Inquirer.js + Chalk）；**Phase 2-3: Web（Vue 3 技术栈）** |
| CLI 工具链 | 交互式命令行 | Commander.js（命令解析）+ Inquirer.js（交互式输入）+ Chalk（彩色输出）+ Ora（加载动画） |
| Web 技术栈 | Phase 2-3 Web 框架 | **Vue 3 + TypeScript + Vite**；状态管理：**Pinia**；路由：**Vue Router**；UI 组件库：**Vuetify 3**（Material 3 实现） |
| 设计规范 | UI/UX 设计风格 | **Material Design 3**（Material You）；使用 Vuetify 3 组件库（官方 Material 3 实现）；支持主题定制与深色模式 |
| 响应式设计 | 多端适配 | **动态适配网页、平板、手机端**；使用 Vuetify 的响应式栅格系统（12 列）；断点：xs/sm/md/lg/xl；移动优先设计原则 |
| 移动端 | 原生客户端支持 | **Phase 3 后可选 Flutter 客户端**；Web 端设计时预留跨平台考虑（组件化、API 统一）；当前通过 Web 响应式支持移动浏览器 |
| 后端 API | Web 服务端 | **Nest.js**（推荐）或 **Express + TypeScript**；提供 REST API 供 Web 和未来 Flutter 客户端调用 |

### 2.2 应用层与领域层

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 语言与运行时 | 如 Python / Node / Go 等 | **TypeScript + Node.js 20+**（最终选择） |
| 理由 | 开发效率、类型安全、技术栈统一 | 团队熟悉 TypeScript；LLM SDK 完全够用；后续 Web 开发前后端统一；类型安全更强 |
| 包管理 | npm/yarn/pnpm | **pnpm**（推荐）或 **npm**；使用 workspace 管理多包 |
| 应用层与领域层边界 | 是否显式区分包结构/模块边界 | **显式区分**：按《概要设计》§2.2 模块划分为独立包/目录 |
| 模块结构示例 | 代码组织 | `src/domain/`（8 大模块）、`src/application/`（编排）、`src/infrastructure/`（存储/LLM）、`src/presentation/`（CLI/Web） |
| 构建工具 | TypeScript 编译 | **tsup** 或 **tsc**；支持 ESM + CommonJS |

### 2.3 基础设施层

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 状态存储 | 内存+文件 / 关系型 / 文档型 / 混合 | **Phase 1-2: 内存 + JSON 文件**；Phase 3 后可选 better-sqlite3/MongoDB |
| 锚点存储 | 与状态存储统一或独立 | **Phase 1-2: JSON 文件**（与状态存储统一格式）；Phase 3 后可选 better-sqlite3 独立管理 |
| 配置与导出包 | JSON/YAML 读写方式；是否引入 Schema 校验 | **JSON 为主**（原生 `JSON.parse/stringify`）；**YAML 可选**（`js-yaml` 库）；引入 **JSON Schema 校验**（`ajv` 库） |
| LLM 接口抽象 | 多家 API 统一调用 | **统一 LLM 接口层**：抽象 `LLMProvider` 接口（TypeScript interface），实现 `DeepseekProvider`、`DoubaoProvider`、`ClaudeProvider`；支持配置切换 |
| HTTP 客户端 | API 调用 | **axios** 或 **node-fetch**；支持重试与超时 |

---

## 三、数据与存储

### 3.1 状态存储

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 存储介质 | 见 §2.3 | **内存 + JSON 文件**（Phase 1-2） |
| 运行时 | 全部状态在内存（TypeScript 对象） | 快速读写；每轮推进后可选自动保存 |
| 持久化 | 快照/存档时序列化为 JSON | 文件路径如 `data/sessions/{session_id}/snapshots/{snapshot_id}.json`；使用 `fs-extra` 库 |
| 状态数据结构 | 与《概要设计》§4.1 核心实体的对应方式 | TypeScript interface/type 或 class；直接映射 Character/WorldState/Information 等实体 |
| 类型校验 | 运行时类型检查 | **Zod** 库（运行时校验 + TypeScript 类型推导）或 **class-validator** |
| 扩展预留 | Phase 3 后优化 | 预留 `StorageAdapter` 接口，可替换为 better-sqlite3/MongoDB 实现 |

### 3.2 锚点存储

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 存储介质与格式 | 与《概要设计》§3.4 锚点标注规范的对应 | **JSON 文件**（Phase 1-2）；路径如 `data/anchors/{storyline_id}/{node_id}.json` |
| 锚点结构 | 必填字段 | 节点 ID、剧情线 ID、时间/顺序、人物列表（对话/已知信息/判断）、环境状态、情节、主题（可选） |
| 查询方式 | Phase 1-2 | 按文件路径直接读取；按剧情线 ID 扫描目录 |
| 扩展预留 | Phase 3 后优化 | 可迁移到 SQLite，支持复杂查询（如按人物 ID/主题标签查询锚点） |

### 3.3 配置与导出包

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 配置格式 | JSON / YAML；是否使用 JSON Schema 等校验 | **JSON 为主**（程序读写）；**YAML 可选**（人类编辑的配置如人设、触发表，使用 `js-yaml`）；使用 **Ajv** 或 **Zod** 校验 |
| 配置类型 | 人设、场景、触发表、评估权重等 | 路径如 `config/characters/`、`config/triggers/`、`config/evaluation.json` |
| 导出包格式 | 文件格式、元数据、依赖 ID 列表约定 | **ZIP 或单 JSON 文件**；包含 `metadata.json`（版本、类型、依赖 ID）+ `data/`（人物/场景/情节等）；使用 `jszip` 或 `archiver` 库 |
| 导出包结构示例 | 人物包 | `{metadata: {version, type: "character", dependencies: []}, data: {character_id, 人设, 初始状态, 行为配置}}` |
| Schema 校验 | 导入时校验 | 使用 **Ajv**（JSON Schema）或 **Zod**（TypeScript-first）校验导入包格式；版本不兼容时提示升级 |

---

## 四、接口与集成

### 4.1 内部模块间接口

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 调用方式 | 函数调用 / 事件 / 服务 API | **Phase 1-2: 直接函数调用**（同进程）；Phase 3 后可选引入事件总线（如 EventEmitter 或消息队列） |
| 接口风格 | 同步 / 异步 | **Phase 1: 同步**；Phase 2-3: 异步（`async/await`），支持并发 Agent 调用 |
| 依赖注入 | 模块间解耦 | 使用依赖注入（如 **tsyringe** 或 **InversifyJS**，或手动构造）；避免循环依赖 |

### 4.2 对外 API（若需要）

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 形态 | 是否提供 REST / GraphQL 等 | **Phase 1-2: 不提供**（本地单机）；Phase 3 服务端部署时提供 **REST API**（Nest.js 或 Express + TypeScript） |
| API 范围 | 服务端部署后 | 剧情推进、状态查询、快照管理、导出导入、对比评估等 |
| API 框架选择 | Phase 3 | **Nest.js**（推荐，架构完整、DI、装饰器）或 **Express + TypeScript**（轻量） |

### 4.3 与 LLM/外部服务的集成

| 项 | 说明 | 当前结论 |
|----|------|----------|
| LLM 接口抽象 | 统一调用层 | **抽象 `LLMProvider` 接口**（TypeScript interface）：`generate(prompt, context): Promise<response>`；实现类：`DeepseekProvider`、`DoubaoProvider`、`ClaudeProvider` |
| API 调用方式 | HTTP 请求 | 使用各家官方 SDK（如 `@anthropic-ai/sdk`、`openai`）或 **axios**；异步调用 |
| SDK 列表 | 具体依赖 | Deepseek（兼容 OpenAI SDK）、豆包（官方 SDK）、Claude（`@anthropic-ai/sdk`） |
| 鉴权 | API Key 管理 | 配置文件或环境变量（`.env`）；使用 **dotenv** 加载 |
| 降级策略 | Phase 3 后 | 当前不实现；Phase 3 后可选：API 失败时降级到规则/缓存/本地模型 |
| 重试与超时 | 容错 | 使用 **axios-retry** 或手动实现重试；设置超时（如 30s） |
| Prompt 管理 | 视野注入与人设 | Prompt 模板化（模板字符串或 **Handlebars**）；注入「人物状态+过滤后视野+当前场景」 |

---

## 五、非功能

### 5.1 性能策略

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 响应时间目标 | 单角色 ≤2s、多角色 ≤5s 对应的技术手段 | **Phase 1-2: 尽力而为**（取决于 LLM API 延迟）；Phase 3 后优化：并发调用、缓存、流式输出 |
| LLM 并发调用 | 多 Agent 场景 | Phase 2 使用 `Promise.all` 或 `Promise.allSettled` 并发调用多个 Agent 的 LLM 请求 |
| 缓存 | Phase 3 后 | 相同 Prompt 缓存结果（**node-cache** 或 Redis）；配置 TTL |
| 异步/队列 | Phase 3 后 | 长时间任务（如批量对比）使用任务队列（**Bull** 或 **BullMQ**） |

### 5.2 安全与多用户

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 多用户隔离 | 认证与数据隔离方式 | **Phase 1-2: 单用户无需认证**；Phase 3 服务端部署时：JWT 认证 + 按会话 ID/用户 ID 隔离数据 |
| 导出/导入安全 | 包的安全校验、敏感信息限制 | **Phase 1-2: JSON Schema 校验**；Phase 3 后：导入包签名校验、敏感信息（如 API Key）不导出 |
| API Key 安全 | LLM API Key 管理 | 不提交到代码仓库；使用 `.env` + `.gitignore`；服务端部署时使用密钥管理服务 |

### 5.3 可扩展性预留

| 项 | 说明 | 当前结论 |
|----|------|----------|
| 水平扩展 | 是否在范围内；若需要，架构预留 | **Phase 1-2: 不考虑**；Phase 3 服务端部署时：无状态应用层 + 共享存储（数据库/对象存储如 MinIO），支持多实例负载均衡 |
| 存储扩展 | 替换存储实现 | **预留 `StorageAdapter` 接口**：Phase 1-2 实现 `JSONFileStorage`；Phase 3 可实现 `SQLiteStorage`（better-sqlite3）/`MongoDBStorage` |
| LLM 扩展 | 新增 LLM 服务商 | **预留 `LLMProvider` 接口**：新增服务商只需实现该接口，无需修改业务逻辑 |
| 规则引擎扩展 | 自定义行为模型 | Phase 3 后：预留 `BehaviorEngine` 接口，支持规则配置（如决策树/状态机）与 LLM 混合 |

---

## 六、技术选型决策记录

### TS-1（第一轮）- 已完成 ✅

**决策时间**：2026-02-04
**决策范围**：部署形态、LLM 使用、存储形态

| 决策项 | 结论 | 理由 |
|--------|------|------|
| 部署形态 | 本地单机（Phase 1-2）→ 服务端（Phase 3） | 快速验证核心功能；后续扩展到多用户 |
| LLM 使用 | 使用第三方 API（Deepseek/豆包/Claude） | 优先功能验证；后续引入本地模型与混合方案 |
| 存储形态 | 内存 + JSON 文件（Phase 1-2）→ SQLite/MongoDB（Phase 3） | 简单、与导出导入天然契合；预留扩展接口 |

### TS-2（第二轮）- 已完成 ✅

**决策时间**：2026-02-04
**决策范围**：表现层技术、应用/领域层语言、配置格式

| 决策项 | 结论 | 理由 |
|--------|------|------|
| 表现层 | Phase 1 用 CLI → Phase 2-3 用 Web（Vue 3） | 快速原型；后续提供更好的交互体验；Vue 3 + TypeScript 开发效率高 |
| 语言 | **TypeScript + Node.js 20+** | 团队熟悉、开发效率高、类型安全强、LLM SDK 完全够用、前后端技术栈统一 |
| 模块边界 | 显式分层（domain/application/infrastructure/presentation） | 符合《概要设计》架构；便于维护 |
| 配置格式 | JSON（程序）+ YAML（人类编辑）+ Ajv/Zod 校验 | 兼顾机器可读与人类可读 |

### TS-3（第三轮）- 已完成 ✅

**决策时间**：2026-02-04
**决策范围**：接口风格、API、安全、性能

| 决策项 | 结论 | 理由 |
|--------|------|------|
| 内部接口 | Phase 1 同步 → Phase 2-3 异步（async/await） | 支持并发 Agent 调用 |
| 对外 API | Phase 1-2 不提供 → Phase 3 提供 REST API | 本地单机无需 API；服务端部署时提供 |
| 安全 | Phase 1-2 单用户 → Phase 3 JWT + 数据隔离 | 逐步增强安全性 |
| 性能 | Phase 1-2 尽力而为 → Phase 3 缓存/并发/队列 | 优先功能验证；后续优化 |

### TS-4（第四轮）- 已完成 ✅

**决策时间**：2026-02-04
**决策范围**：Web 技术栈、UI/UX 设计规范、跨平台预留

| 决策项 | 结论 | 理由 |
|--------|------|------|
| Web 框架 | **Vue 3 + TypeScript + Vite** | 团队熟悉 Vue；Vite 构建速度快；TypeScript 类型安全；与后端技术栈统一 |
| UI 组件库 | **Vuetify 3** | 官方 Material Design 3 实现；组件丰富；响应式栅格系统完善；支持主题定制 |
| 设计规范 | **Material Design 3**（Material You） | 现代化设计语言；跨平台一致性；为未来 Flutter 客户端做准备（Flutter 原生支持 Material 3） |
| 响应式设计 | 动态适配网页/平板/手机端 | 移动优先设计；Vuetify 响应式栅格（xs/sm/md/lg/xl）；统一 API 设计便于未来 Flutter 复用 |
| 跨平台预留 | Phase 3 后可选 Flutter 客户端 | Web 端设计时考虑组件化与 API 统一；Material 3 规范保证设计一致性；当前通过 Web 响应式支持移动端 |

### 扩展预留

| 扩展点 | 接口/抽象 | 说明 |
|--------|-----------|------|
| 存储 | `StorageAdapter` | 可替换为 better-sqlite3/MongoDB 实现 |
| LLM | `LLMProvider` | 新增服务商只需实现该接口 |
| 行为模型 | `BehaviorEngine` | Phase 3 后支持规则配置与 LLM 混合 |

---

## 七、后续行动

技术选型已完成，可在《WBS 任务分解表》中为关键任务补充「实现方式/技术引用」。

**下一步**：开始 Phase 1 开发（见《项目进度表》§2.4）。
