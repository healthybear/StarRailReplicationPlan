# 路径处理说明

## 问题背景

在之前的实现中，项目存在多个路径相关的问题：

1. **环境变量文件路径**：`.env` 文件必须在当前工作目录才能被加载
2. **数据目录路径**：`./data` 和 `./config` 等相对路径依赖于 `process.cwd()`
3. **运行位置限制**：必须从项目根目录运行 CLI，否则会找不到文件

这些问题导致用户体验不佳，容易出错。

## 解决方案

### 1. 自动项目根目录检测

在 CLI 启动时（`packages/cli/src/index.ts`），实现了 `findProjectRoot()` 函数：

```typescript
function findProjectRoot(): string {
  let currentDir = __dirname;

  // 从 CLI dist 目录向上查找，最多查找 5 层
  for (let i = 0; i < 5; i++) {
    const packageJsonPath = path.join(currentDir, 'package.json');

    if (fs.existsSync(packageJsonPath)) {
      try {
        const packageJson = JSON.parse(
          fs.readFileSync(packageJsonPath, 'utf-8')
        );
        // 检查是否是 monorepo 根目录（有 workspaces 字段）
        if (packageJson.workspaces) {
          return currentDir;
        }
      } catch (error) {
        // 忽略 JSON 解析错误，继续向上查找
      }
    }

    currentDir = path.dirname(currentDir);
  }

  // 如果找不到，使用当前工作目录
  return process.cwd();
}
```

**工作原理**：

- 从 CLI 的 `dist` 目录开始，向上遍历目录树
- 查找包含 `workspaces` 字段的 `package.json`（monorepo 根目录的标志）
- 最多向上查找 5 层，避免无限循环
- 如果找不到，回退到当前工作目录

### 2. 自动切换工作目录

找到项目根目录后，自动切换：

```typescript
const projectRoot = findProjectRoot();

if (process.cwd() !== projectRoot) {
  console.log(chalk.gray(`[Info] 切换工作目录到项目根目录: ${projectRoot}`));
  process.chdir(projectRoot);
}
```

这确保了所有相对路径（`./data`、`./config`）都相对于项目根目录解析。

### 3. 简化的环境变量加载

```typescript
const envPath = path.join(projectRoot, '.env');
if (fs.existsSync(envPath)) {
  EnvLoader.load(envPath);
}
```

直接从项目根目录加载 `.env` 文件，不再需要多路径查找。

## 使用效果

### 之前（有问题）

```bash
# 必须从项目根目录运行
cd /path/to/StarRailReplicationPlan
node packages/cli/dist/index.js

# 从其他目录运行会失败
cd /tmp
node /path/to/StarRailReplicationPlan/packages/cli/dist/index.js  # ❌ 找不到 data 目录
```

### 现在（已修复）

```bash
# 可以从任何目录运行
cd /tmp
node /path/to/StarRailReplicationPlan/packages/cli/dist/index.js  # ✅ 自动切换到项目根目录

# 从项目内任何位置运行
cd /path/to/StarRailReplicationPlan/packages/cli
node dist/index.js  # ✅ 自动检测并切换

# 使用启动脚本
./start-cli.sh  # ✅ 始终从项目根目录运行
```

## 相关文件

- **[packages/cli/src/index.ts](../packages/cli/src/index.ts)** - CLI 入口，包含路径检测逻辑
- **[start-cli.sh](../start-cli.sh)** - 启动脚本，确保从项目根目录运行
- **[README.md](../README.md)** - 更新了运行说明

## 依然使用相对路径的地方

以下地方仍然使用相对路径，但现在它们都相对于项目根目录（因为 CLI 会自动切换工作目录）：

1. **数据目录**：`./data` - 存储会话和锚点
2. **配置目录**：`./config` - 存储 YAML 配置文件
3. **导出目录**：`./exports` - 存储导出的包

这些相对路径在以下文件中使用：

- `packages/core/src/container.ts` - 默认 `dataDir = './data'`
- `packages/cli/src/services/story-service.ts` - 默认 `dataDir = './data'`
- `packages/cli/src/services/session-manager.ts` - 默认 `dataDir = './data'`
- `packages/infrastructure/src/storage/json-file-storage.ts` - 默认 `dataDir = './data'`

## 未来改进

如果需要支持自定义数据目录位置，可以考虑：

1. 添加命令行参数：`--data-dir /custom/path`
2. 添加环境变量：`STAR_RAIL_DATA_DIR=/custom/path`
3. 添加配置文件：在项目根目录创建 `.starrailrc` 配置文件

目前的实现已经能满足大部分使用场景。
