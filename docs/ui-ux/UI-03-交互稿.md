# UI-03 交互稿

**文档版本**：v1.0
**创建时间**：2026-02-04
**负责人**：UX/PM
**依赖**：UI-01, UI-02
**状态**：Draft

---

## 文档说明

本文档详细说明所有页面的交互行为、状态转换、动效规范、容错处理和无障碍支持。

---

## 一、核心交互流程

### 1.1 会话创建流程

#### 状态转换图
```
[会话列表]
    ↓ 点击"新建会话"
[步骤1: 基本信息]
    ↓ 填写完成 + 点击"下一步"
[步骤2: 配置加载]
    ↓ 选择/上传配置 + 点击"下一步"
[步骤3: 确认创建]
    ↓ 点击"创建"
[加载中...]
    ↓ 创建成功
[剧情推进主界面]
```

#### 交互细节

**步骤1: 基本信息**
- **输入验证**：
  - 会话名称：必填，1-50 字符，实时验证
  - 会话描述：可选，最多 200 字符
- **错误提示**：
  - 名称为空：输入框下方显示红色文字"请输入会话名称"
  - 名称重复：显示警告"该名称已存在，建议使用其他名称"
- **按钮状态**：
  - "下一步"按钮：表单验证通过前禁用（disabled），通过后启用
- **动效**：
  - 输入框获得焦点：边框颜色变为主色，300ms 过渡
  - 错误提示：淡入动画，200ms

**步骤2: 配置加载**
- **标签页切换**：
  - 默认选中"上传配置包"
  - 切换动画：滑动过渡，300ms
- **文件上传**：
  - 拖拽上传：拖拽区域高亮显示，边框虚线变为实线
  - 文件验证：
    - 格式检查：仅接受 .json, .zip
    - 大小限制：最大 10MB
    - 内容校验：检查 JSON 结构是否合法
  - 上传进度：显示进度条（v-progress-linear），indeterminate 模式
  - 上传成功：显示绿色勾选图标 + 文件名
  - 上传失败：显示红色错误提示 + 重试按钮
- **选择已有配置**：
  - 列表项点击：高亮选中，显示勾选图标
  - 多选支持：可选择多个配置包（人物 + 场景）
  - 预览功能：点击"预览"按钮，弹出配置详情对话框
- **按钮状态**：
  - "下一步"按钮：至少选择一个配置包后启用

**步骤3: 确认创建**
- **信息展示**：
  - 会话名称、描述
  - 已选配置包列表（v-chip 展示）
  - 初始场景描述
- **创建过程**：
  - 点击"创建"按钮
  - 按钮变为加载状态（loading），显示"创建中..."
  - 禁用所有交互（防止重复提交）
  - 创建成功：跳转到剧情推进主界面，显示成功提示（v-snackbar）
  - 创建失败：显示错误对话框，提供重试选项

#### 容错处理

| 错误场景 | 提示内容 | 恢复操作 |
|----------|----------|----------|
| 网络错误 | "网络连接失败，请检查网络后重试" | 提供"重试"按钮 |
| 配置包格式错误 | "配置包格式不正确，请检查文件内容" | 提供"重新上传"按钮 |
| 配置包依赖缺失 | "缺少依赖配置：[依赖名称]，请先导入依赖" | 列出缺失依赖，提供导入入口 |
| 会话名称重复 | "该名称已存在，建议使用其他名称" | 允许继续创建（警告而非阻止） |

---

### 1.2 剧情推进流程

#### 状态转换图
```
[等待输入]
    ↓ 用户输入文本 + 点击"发送"
[解析输入...]
    ↓ 解析成功
[更新状态...]
    ↓ 状态更新完成
[调用 Agent...]
    ↓ Agent 返回结果
[展示对话]
    ↓ 自动滚动到最新
[等待输入]
```

#### 交互细节

**输入区**
- **输入框行为**：
  - 自动增长：输入内容增多时，高度自动增长（最大 6 行）
  - 快捷键：
    - Enter：发送消息
    - Shift+Enter：换行
    - Ctrl+K：清空输入
  - 字符计数：右下角显示字符数（当前/最大）
  - 最大长度：500 字符
- **发送按钮**：
  - 输入为空时禁用
  - 点击后变为加载状态，显示"处理中..."
  - 处理完成后恢复正常状态
- **输入类型识别**：
  - 指令型：以"/"开头，显示指令提示（自动补全）
  - 对话型：@人物名称，高亮显示目标人物
  - 场景修改：以"设置"、"修改"等关键词开头，显示场景修改提示

**对话展示区**
- **对话气泡**：
  - 用户消息：右对齐，主色背景
  - 系统消息：左对齐，灰色背景
  - 人物对话：左对齐，带人物头像，人物主题色背景
- **时间戳**：
  - 每条消息显示时间（HH:mm）
  - 相邻消息时间间隔 < 1 分钟时，隐藏时间戳
- **滚动行为**：
  - 新消息到达：自动滚动到底部，300ms 平滑滚动
  - 用户手动滚动：停止自动滚动
  - 滚动到底部按钮：当用户向上滚动超过 200px 时显示，点击滚动到底部
- **加载状态**：
  - Agent 处理中：显示"正在思考..."动画（三个跳动的点）
  - 位置：对话列表底部

**人物状态面板**
- **切换人物**：
  - 标签页点击：切换到对应人物，300ms 淡入淡出
  - 当前在场人物：标签高亮显示
  - 不在场人物：标签灰色显示，点击提示"该人物不在当前场景"
- **折叠面板**：
  - 默认展开第一个面板（关系）
  - 点击标题：展开/折叠，300ms 高度过渡
  - 支持多个面板同时展开
- **数据更新**：
  - 状态变化：高亮显示变化项，持续 2 秒后恢复
  - 动画：数值变化使用数字滚动动画，500ms

#### 容错处理

| 错误场景 | 提示内容 | 恢复操作 |
|----------|----------|----------|
| 输入为空 | 发送按钮禁用，无提示 | 输入内容后自动启用 |
| 输入过长 | "输入内容过长，最多 500 字符" | 输入框变红，禁止发送 |
| 模糊输入 | "未识别的指令，请重新输入" | 显示提示气泡，保留输入内容 |
| 越权请求 | "该操作超出权限范围，无法修改锚点人物的核心设定" | 显示警告对话框，保留输入内容 |
| 目标人物不在场 | "[人物名称] 不在当前场景" | 显示提示气泡，建议可用人物 |
| Agent 调用失败 | "生成对话失败，请重试" | 提供"重试"按钮 |
| 网络超时 | "请求超时，请检查网络连接" | 提供"重试"按钮 |

---

### 1.3 快照管理流程

#### 状态转换图
```
[剧情推进]
    ↓ 点击"快照"按钮
[快照列表对话框]
    ↓ 点击"新建快照"
[输入快照名称]
    ↓ 确认保存
[保存中...]
    ↓ 保存成功
[快照列表更新] + [成功提示]
```

#### 交互细节

**新建快照**
- **触发方式**：
  - 顶部工具栏"快照"按钮
  - 快捷键：Ctrl+S
- **命名对话框**：
  - 默认名称：自动生成（如"快照 2026-02-04 16:30"）
  - 可编辑：用户可修改名称
  - 验证：名称不能为空，最多 50 字符
- **保存过程**：
  - 显示加载指示器（v-progress-circular）
  - 保存成功：显示成功提示（v-snackbar，3 秒自动关闭）
  - 保存失败：显示错误对话框，提供重试选项

**加载快照**
- **确认对话框**：
  - 提示："加载快照将覆盖当前进度，是否继续？"
  - 按钮："取消" / "确认加载"
- **加载过程**：
  - 显示加载指示器
  - 加载成功：关闭对话框，刷新主界面，显示成功提示
  - 加载失败：显示错误提示，保持当前状态

**删除快照**
- **确认对话框**：
  - 提示："确认删除快照 [快照名称]？此操作不可恢复"
  - 按钮："取消" / "确认删除"（红色）
- **删除过程**：
  - 删除成功：从列表中移除，显示成功提示
  - 删除失败：显示错误提示

**重命名快照**
- **内联编辑**：
  - 点击"重命名"按钮，快照名称变为可编辑状态
  - 输入框获得焦点
  - Enter 确认，Esc 取消
- **验证**：
  - 名称不能为空
  - 名称重复时显示警告

#### 容错处理

| 错误场景 | 提示内容 | 恢复操作 |
|----------|----------|----------|
| 快照名称为空 | "快照名称不能为空" | 输入框变红，禁止保存 |
| 快照名称重复 | "该名称已存在，建议使用其他名称" | 允许继续保存（警告） |
| 保存失败 | "保存快照失败：[错误原因]" | 提供"重试"按钮 |
| 加载失败 | "加载快照失败：[错误原因]" | 提供"重试"按钮，保持当前状态 |
| 快照损坏 | "快照文件已损坏，无法加载" | 提示删除损坏快照 |

---

### 1.4 对比锚点流程

#### 状态转换图
```
[剧情推进]
    ↓ 点击"对比"按钮
[选择锚点对话框]
    ↓ 选择锚点 + 点击"开始对比"
[对比中...]
    ↓ 对比完成
[对比报告页面]
```

#### 交互细节

**选择锚点**
- **锚点列表**：
  - 按剧情线分组显示
  - 每个锚点显示：节点 ID、时间、场景描述
  - 支持搜索：按节点 ID 或场景描述搜索
- **选择行为**：
  - 单选：点击锚点项，高亮显示
  - 预览：点击"预览"按钮，显示锚点详情
- **开始对比**：
  - 按钮：选择锚点后启用
  - 点击后：显示加载指示器，禁用所有交互

**对比报告**
- **总体评分**：
  - 显著展示：大字号，带颜色（绿色 >80%，黄色 60-80%，红色 <60%）
  - 动画：数字从 0 滚动到目标值，1000ms
- **维度切换**：
  - 标签页点击：切换维度，300ms 淡入淡出
  - 默认选中第一个维度（人物状态）
- **差异展示**：
  - 表格行：差异项高亮显示（黄色背景）
  - 差异标记：使用 v-chip，颜色区分（新增/删除/修改）
  - 详情展开：点击行，展开详细差异说明
- **导出报告**：
  - 点击"导出报告"按钮
  - 生成 PDF 或 JSON 文件
  - 下载成功：显示成功提示

#### 容错处理

| 错误场景 | 提示内容 | 恢复操作 |
|----------|----------|----------|
| 未选择锚点 | "请先选择一个锚点" | "开始对比"按钮禁用 |
| 锚点不存在 | "锚点文件不存在或已损坏" | 提示选择其他锚点 |
| 对比失败 | "对比失败：[错误原因]" | 提供"重试"按钮 |
| 导出失败 | "导出报告失败：[错误原因]" | 提供"重试"按钮 |

---

### 1.5 导出/导入流程

#### 导出流程

**状态转换图**
```
[剧情推进]
    ↓ 点击"导出"按钮
[导出对话框]
    ↓ 选择导出类型 + 选择导出项
[生成导出包...]
    ↓ 生成成功
[下载文件] + [成功提示]
```

**交互细节**
- **选择导出类型**：
  - 下拉选择：人物/场景/完整会话
  - 切换时：动态更新可选项列表
- **选择导出项**：
  - 复选框组：列出所有可导出项
  - 全选/取消全选：顶部提供快捷按钮
  - 至少选择一项：未选择时"导出"按钮禁用
- **生成导出包**：
  - 显示进度条（如果数据量大）
  - 生成成功：自动下载文件
  - 文件名：自动生成（如"人物-三月七-20260204.json"）

#### 导入流程

**状态转换图**
```
[会话列表/剧情推进]
    ↓ 点击"导入"按钮
[导入对话框]
    ↓ 上传文件
[解析文件...]
    ↓ 检测到冲突
[冲突处理对话框]
    ↓ 选择策略 + 确认导入
[导入中...]
    ↓ 导入成功
[刷新界面] + [成功提示]
```

**交互细节**
- **上传文件**：
  - 拖拽上传：支持拖拽 .json 或 .zip 文件
  - 点击上传：打开文件选择器
  - 文件验证：检查格式和内容
- **冲突检测**：
  - 自动检测：ID 冲突、依赖缺失
  - 冲突提示：显示警告框（v-alert），列出冲突项
- **冲突策略**：
  - 单选组：拒绝导入/覆盖/重命名
  - 默认选中：拒绝导入（安全策略）
  - 策略说明：每个选项下方显示说明文字
- **导入过程**：
  - 显示进度条
  - 导入成功：刷新界面，显示成功提示
  - 导入失败：显示错误对话框，保持原状态

#### 容错处理

| 错误场景 | 提示内容 | 恢复操作 |
|----------|----------|----------|
| 未选择导出项 | "请至少选择一项导出内容" | "导出"按钮禁用 |
| 生成失败 | "生成导出包失败：[错误原因]" | 提供"重试"按钮 |
| 文件格式错误 | "文件格式不正确，请上传 .json 或 .zip 文件" | 提示重新上传 |
| 文件内容错误 | "文件内容不合法：[错误详情]" | 提示重新上传 |
| ID 冲突 | "检测到 ID 冲突：[冲突列表]" | 提供冲突策略选择 |
| 依赖缺失 | "缺少依赖：[依赖列表]" | 提示先导入依赖 |
| 导入失败 | "导入失败：[错误原因]" | 提供"重试"按钮 |

---

## 二、动效规范

### 2.1 过渡动画

| 动画类型 | 时长 | 缓动函数 | 应用场景 |
|----------|------|----------|----------|
| 淡入淡出 | 300ms | ease-in-out | 页面切换、对话框显示/隐藏 |
| 滑动 | 300ms | ease-out | 标签页切换、抽屉打开 |
| 缩放 | 200ms | ease-out | 按钮点击反馈、卡片悬停 |
| 高度过渡 | 300ms | ease-in-out | 折叠面板展开/折叠 |
| 颜色过渡 | 200ms | ease | 输入框焦点、按钮悬停 |

### 2.2 加载动画

| 加载类型 | 组件 | 说明 |
|----------|------|------|
| 全局加载 | v-progress-linear (indeterminate) | 页面顶部，蓝色进度条 |
| 局部加载 | v-progress-circular | 按钮内、卡片中心 |
| 骨架屏 | v-skeleton-loader | 列表加载、卡片加载 |
| 文字加载 | 跳动的点 | "正在思考..." |

### 2.3 反馈动画

| 反馈类型 | 动画效果 | 时长 |
|----------|----------|------|
| 成功 | 绿色勾选图标淡入 + 轻微缩放 | 500ms |
| 失败 | 红色叉号图标淡入 + 轻微抖动 | 500ms |
| 警告 | 黄色感叹号图标淡入 | 300ms |
| 数值变化 | 数字滚动动画 | 500ms |
| 高亮变化 | 背景色闪烁（黄色 → 透明） | 2000ms |

---

## 三、手势支持（移动端）

### 3.1 基础手势

| 手势 | 操作 | 应用场景 |
|------|------|----------|
| 点击 | 选择、确认 | 所有可交互元素 |
| 长按 | 显示上下文菜单 | 会话卡片、快照项、对话气泡 |
| 滑动 | 切换、删除 | 标签页切换、列表项删除 |
| 双击 | 快速操作 | 对话气泡双击复制 |
| 捏合 | 缩放 | 对比报告图表（可选） |

### 3.2 滑动手势详细说明

**左滑删除**
- **应用场景**：会话列表、快照列表
- **交互**：
  - 左滑：显示删除按钮（红色背景）
  - 继续滑动：直接删除（需确认）
  - 点击其他区域：恢复原状
- **动画**：300ms 滑动过渡

**下拉刷新**
- **应用场景**：会话列表、对话历史
- **交互**：
  - 下拉：显示刷新指示器
  - 释放：开始刷新
  - 刷新完成：指示器消失
- **动画**：弹性过渡

**上滑加载更多**
- **应用场景**：会话列表、对话历史
- **交互**：
  - 滚动到底部：自动加载更多
  - 显示加载指示器
  - 加载完成：追加内容
- **动画**：淡入

---

## 四、键盘导航与快捷键

### 4.1 全局快捷键

| 快捷键 | 操作 | 说明 |
|--------|------|------|
| Ctrl+N | 新建会话 | 打开新建会话对话框 |
| Ctrl+S | 保存快照 | 打开快照命名对话框 |
| Ctrl+E | 导出 | 打开导出对话框 |
| Ctrl+I | 导入 | 打开导入对话框 |
| Ctrl+K | 清空输入 | 清空输入框内容 |
| Ctrl+/ | 显示快捷键帮助 | 打开快捷键列表对话框 |
| Esc | 关闭对话框 | 关闭当前打开的对话框 |

### 4.2 输入区快捷键

| 快捷键 | 操作 | 说明 |
|--------|------|------|
| Enter | 发送消息 | 发送当前输入内容 |
| Shift+Enter | 换行 | 在输入框中插入换行 |
| Ctrl+K | 清空输入 | 清空输入框内容 |
| ↑ | 编辑上一条消息 | 加载上一条用户消息到输入框 |

### 4.3 键盘导航

- **Tab**：在可交互元素间切换焦点
- **Shift+Tab**：反向切换焦点
- **Enter/Space**：激活当前焦点元素
- **Esc**：关闭对话框、取消操作
- **方向键**：在列表中导航

---

## 五、无障碍支持

### 5.1 屏幕阅读器支持

| 元素 | ARIA 属性 | 说明 |
|------|-----------|------|
| 按钮 | aria-label | 描述按钮功能 |
| 输入框 | aria-label, aria-describedby | 标签和说明 |
| 对话框 | role="dialog", aria-modal="true" | 模态对话框 |
| 列表 | role="list", role="listitem" | 列表结构 |
| 标签页 | role="tablist", role="tab" | 标签页结构 |
| 加载状态 | aria-live="polite" | 动态内容更新 |
| 错误提示 | aria-live="assertive" | 重要提示 |

### 5.2 焦点管理

- **对话框打开**：焦点自动移到对话框第一个可交互元素
- **对话框关闭**：焦点返回到触发元素
- **表单提交**：焦点移到结果提示或错误字段
- **列表导航**：方向键导航时，焦点跟随

### 5.3 颜色对比

- **文字对比度**：至少 4.5:1（正文），7:1（标题）
- **交互元素**：至少 3:1
- **错误提示**：不仅依赖颜色，同时使用图标和文字

---

## 六、错误处理总结

### 6.1 错误级别

| 级别 | 说明 | 展示方式 | 示例 |
|------|------|----------|------|
| 信息 | 提示性信息 | v-snackbar (蓝色) | "快照已保存" |
| 警告 | 需要注意但不阻止操作 | v-alert (黄色) | "会话名称重复" |
| 错误 | 操作失败，需要处理 | v-dialog (红色) | "导入失败" |
| 致命 | 系统错误，无法继续 | 全屏错误页 | "服务器连接失败" |

### 6.2 错误恢复策略

| 策略 | 说明 | 应用场景 |
|------|------|----------|
| 重试 | 提供"重试"按钮 | 网络错误、临时故障 |
| 回滚 | 恢复到操作前状态 | 导入失败、加载快照失败 |
| 降级 | 提供简化功能 | Agent 调用失败时使用规则 |
| 引导 | 提示用户如何解决 | 依赖缺失、配置错误 |
| 忽略 | 允许用户继续操作 | 非关键警告 |

---

## 七、性能优化

### 7.1 加载优化

- **懒加载**：对话历史分页加载，每次加载 20 条
- **虚拟滚动**：长列表使用虚拟滚动（v-virtual-scroll）
- **图片懒加载**：人物头像使用懒加载
- **骨架屏**：首次加载显示骨架屏，提升感知性能

### 7.2 交互优化

- **防抖**：搜索输入 300ms 防抖
- **节流**：滚动事件 100ms 节流
- **乐观更新**：用户操作立即反馈，后台异步处理
- **缓存**：已加载的配置包缓存到本地

---

## 附录

### 参考文档
- [UI-01 体验目标与信息架构](UI-01-体验目标与信息架构.md)
- [UI-02 关键页面详细描述](UI-02-关键页面详细描述.md)
- [Material Design 动效指南](https://m3.material.io/styles/motion)
- [WCAG 2.1 无障碍指南](https://www.w3.org/WAI/WCAG21/quickref/)

---

**文档状态**：待评审
**下一步**：UI-04 视觉稿与组件规范（W2）
