# QA-P1-01 测试用例设计文档

**文档版本**：v1.0
**创建日期**：2026-02-17
**状态**：已完成
**对应里程碑**：M3（Phase 1 MVP 开发完成）

---

## 一、文档目标

本文档记录 Phase 1 MVP 的测试用例设计，基于 WBS 任务分解表和各模块的验收标准，为测试执行提供明确指导。

---

## 二、测试策略

### 2.1 测试范围

根据 [Phase1-开发落地方案.md](Phase1-开发落地方案.md) 第8.1节，Phase 1 的测试范围包括：

- **基础设施层**：ConfigLoader, Storage, LLM Provider
- **核心模块**：BehaviorEngine, TriggerEngine, VisionManager, PromptBuilder
- **业务模块**：CharacterAgent, InputParser, StoryOrchestrator, ExportImport, AnchorEvaluation

### 2.2 测试框架

- **测试框架**：Jest 29.7.0
- **TypeScript 支持**：ts-jest 29.1.1
- **测试环境**：Node.js 20.x LTS

### 2.3 覆盖率要求

根据 jest.config.js 配置：

- 分支覆盖率 ≥ 60%
- 函数覆盖率 ≥ 60%
- 行覆盖率 ≥ 60%
- 语句覆盖率 ≥ 60%

---

## 三、测试用例清单

### 3.1 基础设施层测试（packages/infrastructure）

#### 3.1.1 ConfigLoader 测试

**测试文件**：`packages/infrastructure/src/config/__tests__/config-loader.test.ts`

| 测试用例 ID | 测试用例名称         | 测试目的                     | 预期结果                 | 状态    |
| ----------- | -------------------- | ---------------------------- | ------------------------ | ------- |
| INF-CFG-001 | 加载有效的YAML文件   | 验证YAML文件正确解析         | 配置对象正确生成         | ✅ 通过 |
| INF-CFG-002 | YAML Schema校验失败  | 验证不符合Schema的配置被拒绝 | 抛出Zod校验错误          | ✅ 通过 |
| INF-CFG-003 | 加载不存在的YAML文件 | 验证文件不存在时的处理       | 抛出明确错误             | ✅ 通过 |
| INF-CFG-004 | 加载有效的JSON文件   | 验证JSON文件正确解析         | 配置对象正确生成         | ✅ 通过 |
| INF-CFG-005 | JSON Schema校验失败  | 验证不符合Schema的配置被拒绝 | 抛出Zod校验错误          | ✅ 通过 |
| INF-CFG-006 | 加载格式错误的JSON   | 验证JSON格式错误时的处理     | 抛出解析错误             | ✅ 通过 |
| INF-CFG-007 | 批量加载目录配置     | 验证批量加载多个配置文件     | 返回Map包含所有配置      | ✅ 通过 |
| INF-CFG-008 | 加载不存在的目录     | 验证目录不存在时的处理       | 返回空Map                | ✅ 通过 |
| INF-CFG-009 | 跳过非配置文件       | 验证只加载YAML/JSON文件      | 忽略其他文件类型         | ✅ 通过 |
| INF-CFG-010 | 检查文件存在性       | 验证exists方法               | 正确返回true/false       | ✅ 通过 |
| INF-CFG-011 | 保存YAML配置         | 验证配置保存功能             | 文件正确保存且可重新加载 | ✅ 通过 |
| INF-CFG-012 | 创建嵌套目录         | 验证自动创建父目录           | 嵌套目录和文件正确创建   | ✅ 通过 |
| INF-CFG-013 | 保存JSON配置         | 验证JSON保存功能             | 文件正确保存且可重新加载 | ✅ 通过 |
| INF-CFG-014 | JSON格式化           | 验证JSON缩进格式             | 包含换行和缩进           | ✅ 通过 |

**测试覆盖率**：14/14 通过

#### 3.1.2 JsonFileStorage 测试

**测试文件**：`packages/infrastructure/src/storage/__tests__/json-file-storage.test.ts`

| 测试用例 ID | 测试用例名称         | 测试目的                 | 预期结果             | 状态        |
| ----------- | -------------------- | ------------------------ | -------------------- | ----------- |
| INF-STG-001 | 保存和加载会话状态   | 验证会话状态持久化       | 保存后能正确加载     | ✅ 通过     |
| INF-STG-002 | 加载不存在的会话     | 验证加载不存在的会话     | 返回null             | ✅ 通过     |
| INF-STG-003 | 覆盖现有会话         | 验证会话覆盖功能         | 新数据覆盖旧数据     | ✅ 通过     |
| INF-STG-004 | 更新lastSaved时间戳  | 验证时间戳自动更新       | lastSaved大于原值    | ✅ 通过     |
| INF-STG-005 | 删除现有会话         | 验证会话删除功能         | 会话被删除           | ✅ 通过     |
| INF-STG-006 | 删除不存在的会话     | 验证删除不存在会话不报错 | 不抛出异常           | ✅ 通过     |
| INF-STG-007 | 列出所有会话         | 验证列出所有会话ID       | 返回所有会话ID       | ✅ 通过     |
| INF-STG-008 | 空会话列表           | 验证无会话时的列表       | 返回空数组           | ✅ 通过     |
| INF-STG-009 | 检查会话存在性       | 验证sessionExists方法    | 正确返回true/false   | ✅ 通过     |
| INF-STG-010 | 保存和加载快照       | 验证快照功能             | 快照能正确保存和恢复 | ⚠️ 部分失败 |
| INF-STG-011 | 加载不存在的快照     | 验证加载不存在的快照     | 返回null             | ✅ 通过     |
| INF-STG-012 | 保存多个快照         | 验证同一会话多个快照     | 所有快照正确保存     | ⚠️ 部分失败 |
| INF-STG-013 | 列出会话快照         | 验证列出会话的所有快照   | 返回所有快照ID       | ⚠️ 失败     |
| INF-STG-014 | 空快照列表           | 验证无快照时的列表       | 返回空数组           | ✅ 通过     |
| INF-STG-015 | 不存在会话的快照列表 | 验证不存在会话的快照列表 | 返回空数组           | ✅ 通过     |
| INF-STG-016 | 删除快照             | 验证快照删除功能         | 快照被删除           | ⚠️ 失败     |
| INF-STG-017 | 删除不存在的快照     | 验证删除不存在快照不报错 | 不抛出异常           | ✅ 通过     |
| INF-STG-018 | 复杂数据结构完整性   | 验证复杂嵌套数据保存     | 数据完整保存和恢复   | ✅ 通过     |

**测试覆盖率**：15/18 通过（快照功能有3个失败）

**已知问题**：快照相关测试失败，需要修复 JsonFileStorage 的快照功能实现。

---

### 3.2 核心模块测试（packages/core）

#### 3.2.1 BehaviorEngine 测试

**测试文件**：`packages/core/src/character-state/__tests__/character-state.test.ts`

| 测试用例 ID  | 测试用例名称     | 测试目的               | 预期结果                                                   | 状态    |
| ------------ | ---------------- | ---------------------- | ---------------------------------------------------------- | ------- |
| CORE-BEH-001 | 推导探索倾向     | 验证探索倾向公式       | exploration = 0.7×openness + 0.3×extraversion              | ✅ 通过 |
| CORE-BEH-002 | 推导合作倾向     | 验证合作倾向公式       | cooperation = 0.7×agreeableness + 0.3×extraversion         | ✅ 通过 |
| CORE-BEH-003 | 推导谨慎倾向     | 验证谨慎倾向公式       | caution = 0.6×conscientiousness + 0.4×neuroticism          | ✅ 通过 |
| CORE-BEH-004 | 推导冲动倾向     | 验证冲动倾向公式       | impulsivity = 0.6×(1-conscientiousness) + 0.4×extraversion | ✅ 通过 |
| CORE-BEH-005 | 推导自信倾向     | 验证自信倾向公式       | assertiveness = 0.7×extraversion + 0.3×(1-neuroticism)     | ✅ 通过 |
| CORE-BEH-006 | 返回已有行为倾向 | 验证已有倾向不重新计算 | 返回现有值                                                 | ✅ 通过 |
| CORE-BEH-007 | 自动推导行为倾向 | 验证缺失时自动推导     | 根据五大人格推导                                           | ✅ 通过 |

**测试覆盖率**：7/7 通过

#### 3.2.2 TriggerEngine 测试

**测试文件**：`packages/core/src/character-state/__tests__/character-state.test.ts`

| 测试用例 ID  | 测试用例名称           | 测试目的       | 预期结果            | 状态    |
| ------------ | ---------------------- | -------------- | ------------------- | ------- |
| CORE-TRG-001 | Delta变化应用到关系    | 验证增量变化   | 关系值正确增加      | ✅ 通过 |
| CORE-TRG-002 | Set变化应用到关系      | 验证直接设置   | 关系值设置为指定值  | ✅ 通过 |
| CORE-TRG-003 | Multiply变化应用到关系 | 验证乘法变化   | 关系值正确相乘      | ✅ 通过 |
| CORE-TRG-004 | 应用变化到能力         | 验证能力值变化 | 能力值正确更新      | ✅ 通过 |
| CORE-TRG-005 | 尊重最小最大边界       | 验证边界限制   | 值不超出min/max范围 | ✅ 通过 |
| CORE-TRG-006 | 按事件类型过滤规则     | 验证规则过滤   | 只应用匹配的规则    | ✅ 通过 |
| CORE-TRG-007 | 按优先级执行规则       | 验证优先级排序 | 高优先级先执行      | ✅ 通过 |

**测试覆盖率**：7/7 通过

#### 3.2.3 CharacterStateService 测试

**测试文件**：`packages/core/src/character-state/__tests__/character-state.test.ts`

| 测试用例 ID  | 测试用例名称       | 测试目的         | 预期结果           | 状态    |
| ------------ | ------------------ | ---------------- | ------------------ | ------- |
| CORE-CSS-001 | 加载触发表并排序   | 验证触发表加载   | 规则按优先级排序   | ✅ 通过 |
| CORE-CSS-002 | 按事件类型获取规则 | 验证规则过滤     | 返回匹配的规则     | ✅ 通过 |
| CORE-CSS-003 | 获取现有关系       | 验证关系获取     | 返回现有关系       | ✅ 通过 |
| CORE-CSS-004 | 创建默认关系       | 验证关系自动创建 | 创建默认关系       | ✅ 通过 |
| CORE-CSS-005 | 更新关系并记录     | 验证关系更新     | 关系更新且记录变化 | ✅ 通过 |
| CORE-CSS-006 | 处理事件并返回变化 | 验证事件处理     | 返回状态变化列表   | ✅ 通过 |
| CORE-CSS-007 | 状态变化监听器     | 验证监听器通知   | 监听器被正确调用   | ✅ 通过 |
| CORE-CSS-008 | 移除监听器         | 验证监听器移除   | 移除后不再调用     | ✅ 通过 |
| CORE-CSS-009 | 获取状态摘要       | 验证状态摘要     | 返回正确的统计信息 | ✅ 通过 |
| CORE-CSS-010 | 触发表配置验证     | 验证触发表生效   | 配置规则正确应用   | ✅ 通过 |

**测试覆盖率**：10/10 通过

#### 3.2.4 VisionManager 测试

**测试文件**：`packages/core/src/vision-manager/__tests__/vision-manager.test.ts`

| 测试用例 ID  | 测试用例名称     | 测试目的         | 预期结果             | 状态    |
| ------------ | ---------------- | ---------------- | -------------------- | ------- |
| CORE-VIS-001 | 无已知信息的视野 | 验证空视野       | 返回空数组           | ✅ 通过 |
| CORE-VIS-002 | 视野隔离验证     | 验证信息隔离     | 角色只看到自己的信息 | ✅ 通过 |
| CORE-VIS-003 | 添加全局信息     | 验证信息添加     | 信息正确添加到全局库 | ✅ 通过 |
| CORE-VIS-004 | 分配信息给角色   | 验证信息分配     | 信息正确分配给角色   | ✅ 通过 |
| CORE-VIS-005 | 批量分配信息     | 验证批量分配     | 多个信息正确分配     | ✅ 通过 |
| CORE-VIS-006 | 事件驱动信息归属 | 验证事件归属规则 | 根据规则自动分配信息 | ✅ 通过 |
| CORE-VIS-007 | 目睹规则         | 验证目睹归属     | 在场角色获得信息     | ✅ 通过 |
| CORE-VIS-008 | 听闻规则         | 验证听闻归属     | 附近角色获得信息     | ✅ 通过 |
| CORE-VIS-009 | 被告知规则       | 验证被告知归属   | 目标角色获得信息     | ✅ 通过 |

**测试覆盖率**：9/9 通过

#### 3.2.5 其他核心模块测试

| 模块              | 测试文件                      | 测试用例数 | 通过数 | 状态        |
| ----------------- | ----------------------------- | ---------- | ------ | ----------- |
| InputParser       | input-parser.test.ts          | 25         | 25     | ✅ 全部通过 |
| CharacterAgent    | character-agent.test.ts       | 30         | 30     | ✅ 全部通过 |
| StoryOrchestrator | story-orchestrator.test.ts    | 42         | 42     | ✅ 全部通过 |
| ExportImport      | export-import.service.test.ts | 35         | 35     | ✅ 全部通过 |
| AnchorEvaluation  | anchor-evaluator.test.ts      | 28         | 28     | ✅ 全部通过 |

---

## 四、测试执行结果

### 4.1 总体统计

| 包                        | 测试套件 | 测试用例 | 通过    | 失败  | 覆盖率（语句/分支/函数/行）   |
| ------------------------- | -------- | -------- | ------- | ----- | ----------------------------- |
| @star-rail/infrastructure | 2        | 34       | 34      | 0     | 46.7% / 17.1% / 40.3% / 46.5% |
| @star-rail/core           | 7        | 193      | 193     | 0     | 82.8% / 61.8% / 86.7% / 83.5% |
| **总计**                  | **9**    | **227**  | **227** | **0** | **✅ Core达标**               |

### 4.2 失败用例分析

**当前状态**：✅ 所有测试通过

**已修复问题**：

1. JsonFileStorage 快照功能 - 修复了 Snapshot Schema 字段名称不一致问题
2. lastSaved 时间戳更新 - 在 saveSession 方法中添加了时间戳自动更新

---

## 五、Phase 1 验收标准测试

根据 [WBS任务分解表.md](WBS任务分解表.md) 和 [概要设计.md](概要设计.md)，Phase 1 的验收标准：

### 5.1 视野隔离验证 ✅

**测试用例**：CORE-VIS-002

**验收标准**：1场景+2角色下，某信息仅A知时，B的回复不包含该信息

**测试结果**：✅ 通过

**测试代码位置**：[packages/core/src/vision-manager/**tests**/vision-manager.test.ts:66-81](../../packages/core/src/vision-manager/__tests__/vision-manager.test.ts#L66-L81)

### 5.2 剧情推进可控 ✅

**测试用例**：StoryOrchestrator 相关测试

**验收标准**：指令型/对话型输入能正确解析并驱动一轮剧情

**测试结果**：✅ 通过（42个测试全部通过）

### 5.3 导出/导入可用 ✅

**测试用例**：ExportImport 相关测试

**验收标准**：人物/场景JSON导出包可成功导入并在新会话中加载

**测试结果**：✅ 通过（35个测试全部通过）

### 5.4 对比结果可见 ✅

**测试用例**：AnchorEvaluation 相关测试

**验收标准**：单节点对比可输出差异说明（人物状态+视野）

**测试结果**：✅ 通过（28个测试全部通过）

### 5.5 状态演化可配置 ✅

**测试用例**：CORE-CSS-010

**验收标准**：至少1个关系维度可配置触发并生效

**测试结果**：✅ 通过

---

## 六、测试覆盖率报告

### 6.1 Core 包覆盖率

| 指标       | 覆盖率 | 目标 | 状态    |
| ---------- | ------ | ---- | ------- |
| 语句覆盖率 | 82.75% | ≥60% | ✅ 达标 |
| 分支覆盖率 | 61.80% | ≥60% | ✅ 达标 |
| 函数覆盖率 | 86.70% | ≥60% | ✅ 达标 |
| 行覆盖率   | 83.52% | ≥60% | ✅ 达标 |

**详细覆盖率**：

| 模块               | 语句   | 分支   | 函数   | 行     |
| ------------------ | ------ | ------ | ------ | ------ |
| input-parser       | 100%   | 100%   | 100%   | 100%   |
| anchor-evaluation  | 96.42% | 83.72% | 100%   | 96.99% |
| character-agent    | 88.69% | 75.26% | 100%   | 95.68% |
| story-orchestrator | 91.47% | 72.13% | 100%   | 92%    |
| export-import      | 85.36% | 65.82% | 100%   | 85.71% |
| character-state    | 74.85% | 49.13% | 77.14% | 74.21% |
| vision-manager     | 60%    | 26.22% | 74.19% | 58.06% |
| world-engine       | 45.83% | 20%    | 33.33% | 40.9%  |

### 6.2 Infrastructure 包覆盖率

| 指标       | 覆盖率 | 目标 | 状态      |
| ---------- | ------ | ---- | --------- |
| 语句覆盖率 | 46.70% | ≥60% | ⚠️ 未达标 |
| 分支覆盖率 | 17.14% | ≥60% | ⚠️ 未达标 |
| 函数覆盖率 | 40.32% | ≥60% | ⚠️ 未达标 |
| 行覆盖率   | 46.48% | ≥60% | ⚠️ 未达标 |

**详细覆盖率**：

| 模块                 | 语句 | 分支   | 函数 | 行   |
| -------------------- | ---- | ------ | ---- | ---- |
| config-loader        | 100% | 85.71% | 100% | 100% |
| json-file-storage    | 100% | 85.71% | 100% | 100% |
| env-loader           | 0%   | 0%     | 0%   | 0%   |
| app-error            | 0%   | 0%     | 0%   | 0%   |
| llm-provider-factory | 0%   | 0%     | 0%   | 0%   |
| claude.provider      | 0%   | 0%     | 0%   | 0%   |
| deepseek.provider    | 0%   | 0%     | 0%   | 0%   |
| logger               | 0%   | 0%     | 0%   | 0%   |

**说明**：Infrastructure 包的覆盖率较低是因为 LLM Provider、Logger、Error Handler 等模块未编写测试。这些模块在 Phase 1 中主要用于集成测试，单元测试可在 Phase 2 补充。

### 6.3 总体评估

- ✅ **Core 包**：所有指标超过 60%，达到 Phase 1 要求
- ⚠️ **Infrastructure 包**：核心模块（ConfigLoader, Storage）达到 100% 覆盖率，但整体因未测试模块拉低
- ✅ **Phase 1 验收标准**：所有 5 项验收标准通过测试验证

---

## 七、已修复问题

### 7.1 已修复

| 问题 ID | 问题描述                     | 修复方案                                         | 状态      |
| ------- | ---------------------------- | ------------------------------------------------ | --------- |
| BUG-001 | JsonFileStorage 快照功能失败 | 修复 Snapshot Schema 字段名称（snapshotId → id） | ✅ 已修复 |
| BUG-002 | lastSaved 时间戳未更新       | 在 saveSession 中添加时间戳自动更新逻辑          | ✅ 已修复 |

### 7.2 待优化（Phase 2）

| 问题 ID | 问题描述                               | 优先级 | 计划                                               |
| ------- | -------------------------------------- | ------ | -------------------------------------------------- |
| OPT-001 | Infrastructure 包覆盖率较低            | P1     | Phase 2 补充 LLM Provider、Logger 等模块的单元测试 |
| OPT-002 | VisionManager 分支覆盖率较低（26.22%） | P2     | Phase 2 补充边界条件测试                           |
| OPT-003 | WorldEngine 覆盖率较低（45.83%）       | P2     | Phase 2 补充世界引擎测试                           |

---

## 八、测试环境

### 8.1 开发环境

- Node.js: 20.x LTS
- pnpm: 10.13.1
- TypeScript: 5.3.3
- Jest: 29.7.0
- ts-jest: 29.1.1

### 8.2 CI/CD 集成

待配置（Phase 2）

---

## 九、参考文档

- [Phase1-开发落地方案.md](Phase1-开发落地方案.md)
- [WBS任务分解表.md](WBS任务分解表.md)
- [概要设计.md](概要设计.md)
- [项目进度表.md](项目进度表.md)

---

## 十、变更记录

| 版本 | 日期       | 变更内容                                        | 变更人            |
| ---- | ---------- | ----------------------------------------------- | ----------------- |
| v1.0 | 2026-02-17 | 初始版本，记录Phase 1测试用例设计和执行结果     | Claude Sonnet 4.5 |
| v1.1 | 2026-02-17 | 更新测试结果：所有227个测试通过，添加覆盖率报告 | Claude Sonnet 4.5 |
