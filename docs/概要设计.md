# 《星穹铁道剧情复现计划》概要设计

本文档基于《需求文档-星穹铁道剧情复现计划》与《需求评审1》的结论，给出系统总体架构、核心模块职责、关键流程与数据模型、以及评审中提出的缺失项在设计层面的落地方案。

---

## 一、设计目标与原则

### 1.1 设计目标

- **四要素可建模、可演化**：人物、环境、情节、主题均有显式数据模型与状态机，支持随剧情演化与快照。
- **人物视觉可落地**：信息获取/过滤/存储规则明确，Agent 行为严格受「该人物当前所知信息」约束。
- **状态演化可配置、可量化**：关系/能力/性格等维度有统一量化表示与触发规则，支持配置驱动而非硬编码。
- **用户输入可解析、可边界**：输入分类、容错与权限边界清晰，避免「规则模糊导致实现偏差」。
- **导出/导入可冲突可适配**：ID 冲突、状态覆盖、依赖缺失、跨剧情适配均有明确策略。
- **对比/评估可量化可追溯**：贴合度多维度权重与评分规则可配置，原剧情锚点有统一标注规范。

### 1.2 设计原则

- **数据驱动**：人物、环境、情节、主题、锚点均以结构化数据（JSON/YAML）描述，逻辑与数据分离。
- **单一信息源**：全局世界状态与各人物「已知信息」分离存储，行为生成时仅注入该人物视野。
- **可追溯**：状态变化、信息获取、用户操作均有来源与时间戳，便于对比与回放。
- **分阶段可验收**：各 Phase 对应明确验收标准与依赖，便于迭代与排期。

---

## 二、系统总体架构

### 2.1 逻辑分层

```
┌─────────────────────────────────────────────────────────────────┐
│  表现层 (Presentation)                                            │
│  用户输入、剧情展示、状态可视化、对比报告、导出/导入操作界面        │
├─────────────────────────────────────────────────────────────────┤
│  应用层 (Application)                                             │
│  剧情会话编排、用户意图解析与分发、快照/对比/导出导入编排           │
├─────────────────────────────────────────────────────────────────┤
│  领域层 (Domain)                                                  │
│  人物 Agent、世界引擎(环境/情节/主题)、信息与状态演化、对比评估     │
├─────────────────────────────────────────────────────────────────┤
│  基础设施层 (Infrastructure)                                      │
│  状态存储、锚点存储、配置加载、导出包读写、可选 LLM/推理服务        │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块划分

| 模块 | 职责 | 对应需求 |
|------|------|----------|
| **用户输入解析 (Input Parser)** | 对用户文字做分类（指令/对话/场景修改/无意义）、意图抽取、权限校验、容错与澄清策略 | 2.7 用户输入、评审§1.3 |
| **世界引擎 (World Engine)** | 维护全局环境（场景/星球/势力/氛围）、情节（事件链/节点/分支）、主题；驱动环境与情节演化；提供「当前世界状态」查询 | 2.3 环境、2.4 情节、2.5 主题、2.6 |
| **信息与视野管理 (Vision Manager)** | 定义信息的产生、传播、归属；维护每人「已知信息库」；提供「过滤后视野」给 Agent；支持信息遗忘/模糊规则 | 2.1 人物视觉、2.2 视野演化、评审§1.1 |
| **人物状态与演化 (Character State)** | 人物状态维度（关系/能力/修养/性格/视野）的量化表示、演化触发规则、约束校验、快照与回溯 | 2.1、2.2、评审§1.2 |
| **角色 Agent (Character Agent)** | 基于「当前人物状态 + 该人物视野」生成对话与行动；不直接访问全局状态；多 Agent 时协调与冲突裁决 | 2.1、2.7 |
| **剧情推进编排 (Story Orchestrator)** | 接收用户输入与 Agent 输出，更新世界状态与人物状态，推进事件链，处理多 Agent 冲突与死胡同兜底 | 2.7、评审§五 异常 |
| **锚点与对比评估 (Anchor & Evaluation)** | 原剧情锚点的存储、标注规范；当前分支与锚点的多维度对比；贴合度量化与报告生成 | 2.8、评审§2、§3.1 |
| **导出/导入 (Export/Import)** | 人物/环境/情节/主题/道具的序列化、冲突处理、依赖检查、跨剧情适配规则 | 第三章、评审§二 |

---

## 三、核心设计

### 3.1 人物视觉与信息管理（对应评审§1.1）

#### 3.1.1 信息获取的触发规则

| 获取方式 | 判定条件 | 说明 |
|----------|----------|------|
| **目睹** | 角色在当前场景内 + 事件发生在「可见范围」+ 无配置的遮挡/隐藏 | 由「事件发生时的场景 ID + 在场角色列表」驱动；可配置「该事件对某角色不可见」 |
| **听闻** | 同一场景内且距离≤配置的「听闻半径」；或通过「传话」事件显式传递 | 支持按场景配置「全场景可听」或「仅近距离」 |
| **被告知** | 显式「告知」事件：发送者、接收者、信息 ID、是否可失真（如传话失真） | 传递逻辑可配置：直接复制 / 带噪声 / 带延迟 |
| **推理** | 仅允许基于「已知信息 + 配置的推理规则」推导；禁止超设定推理 | 推理规则以「前提信息 ID → 结论信息 ID」形式配置，避免开放推理导致泄密 |

信息条目统一用 **信息 ID** 表示，每条信息带：来源（目睹/听闻/被告知/推理）、时间戳、场景、关联事件 ID；人物「已知信息库」为信息 ID 集合 + 获取时间，用于追溯与遗忘计算。

#### 3.1.2 信息存储与检索

- **全局信息库**：所有「已发生且可被某角色接触」的信息 ID 及元数据（时间、场景、来源类型）。
- **每人已知信息库**：按人物 ID 索引，存储该人物当前已知的**信息 ID 列表**（可带获取时间、置信度/模糊度，用于遗忘与模糊）。
- **行为/对话生成时的约束**：调用 Agent 前，由 **Vision Manager** 根据当前人物 ID 从全局信息库中**过滤**出该人物已知信息子集，与「当前人物状态」一起注入；Agent 接口**不接收**全局世界状态，仅接收「过滤后的视野 + 允许的当前场景环境描述」。

#### 3.1.3 信息遗忘/模糊规则（可配置）

- **遗忘**：对非关键信息（未标记为「关键记忆」），可配置「超过 N 个剧情节点未使用则移出已知信息」或「超过 T 时间则置信度衰减至遗忘」。
- **模糊**：长线剧情中可配置「远期信息」仅保留「摘要」或「标签」，细节不再参与推理与生成，避免人物「永远记得所有细节」。

---

### 3.2 状态演化的量化与可配置（对应评审§1.2）

#### 3.2.1 量化维度与表示

| 维度 | 建议表示 | 示例 |
|------|----------|------|
| **关系** | 标签 + 数值（0–1 或 0–100），如 `{ "信任": 0.8, "敌对": 0.2 }` 或单轴「亲密度 -100～100」 | 可配置选用「多标签权重」或「单轴」 |
| **能力** | 技能 ID + 数值或等级，如 `{ "战斗": 65, "知识-星核": 40 }` | 上下限与步长可配置 |
| **修养/性格** | 维度名 + 数值（0–1），如五大人格或自定义「谨慎/冲动」「开放/封闭」 | 由策划/运营在配置中定义维度列表 |
| **视野** | 已知信息 ID 集合 + 可选置信度/时间戳 | 见 3.1 |

演化结果**写回**到人物状态存储；支持按「事件类型 + 目标维度」配置变化量或公式（见下）。

#### 3.2.2 演化触发与阈值（可配置）

- **触发表**：配置「事件类型 / 事件 ID → 受影响人物 → 维度 → 变化规则」。
  - 示例：`事件=背叛，施动者=B，对象=A → A 对 B 的信任 -= 30（下限 0）」；`事件=完成任务X → 角色 能力[战斗] += 5（上限 100）」。
- **变化规则**：支持「固定增量」「百分比」「公式（如与当前值相关）」；支持上下限与是否允许回退。
- **配置入口**：优先支持 JSON/YAML 配置表；后期可做「可视化配置面板」由运营维护同一套表。

---

### 3.3 用户输入解析与容错（对应评审§1.3）

#### 3.3.1 输入类型与解析

| 输入类型 | 识别方式 | 输出 |
|----------|----------|------|
| **指令型** | 关键词/模板（如「让三月七说话」「星，去开门」） | 目标角色 ID + 动作类型 + 可选参数 |
| **对话型** | 对某角色说：xxx（指定对象 + 内容） | 目标角色 ID + 文本内容，作为「用户对该角色说的话」参与剧情 |
| **场景修改型** | 描述环境变化（如「把灯关掉」「下雨了」） | 解析为环境状态变更事件，写入世界引擎 |
| **无意义/乱码** | 长度、符号比例、与意图模型置信度低于阈值 | 归类为「无法解析」，走容错策略 |

意图识别可采用规则 + 轻量意图分类模型；指令型与对话型优先保证稳定，场景修改型可 Phase 2 细化。

#### 3.3.2 容错与权限

- **模糊/歧义**：置信度不足时，可配置「反问澄清」「默认忽略」「按人设推导一种解释」；建议默认「反问澄清」或「忽略并提示」。
- **权限边界**：在配置中声明「用户可修改范围」与「不可变锚点」。
  - 用户**不可**直接修改：人物核心设定（如身份、阵营绑定）、标记为「不可变」的剧情锚点（如关键死亡）。
  - 用户**可**：通过输入驱动剧情走向、触发对话、提出场景变化；是否采纳由世界引擎/Agent 规则决定，而非直接写库。
- 越权请求（如「让星核猎手立刻变成友方」）可拒绝并返回「超出权限」或转为「建议/愿望」由剧情逻辑部分吸收。

---

### 3.4 原剧情锚点标注规范（对应评审§2.2）

- **锚点粒度**：按「关键剧情选择点」+「关键对话/反应节点」标注；可配置「每 N 分钟」或「每 M 个对话」作为辅助粒度，主粒度仍以关键节点为准。
- **必填字段（每节点）**：
  - 节点 ID、剧情线 ID、时间/顺序；
  - **人物**：该节点涉及角色列表，每人「对话/选择/态度」+ **已知信息 ID 列表** + **对事件的判断结论（可结构化或短文本）」；
  - **环境**：场景 ID、势力/氛围状态摘要；
  - **情节**：事件 ID、分支选择、因果说明；
  - **主题**：本节点体现的主题标签或命题（可选）。
- **来源与更新**：锚点数据来源在元数据中标注（官方剧本/录屏抽取/人工标注）；原作更新时通过「锚点版本 + 剧情线版本」做增量更新或重新标注流程。

---

### 3.5 导出/导入的冲突与适配（对应评审§二）

#### 3.5.1 冲突处理

| 冲突类型 | 策略（可配置） |
|----------|----------------|
| **ID 冲突** | 选项：覆盖 / 自动重命名（如加后缀） / 提示用户选择（覆盖/重命名/终止） |
| **状态覆盖** | 导入「人物状态快照」时：选项「完全替换」/「按维度合并」（如仅合并能力，保留当前关系） / 提示用户选择 |
| **依赖缺失** | 依赖的 scene/character 未导入：选项「自动创建占位默认」/「提示用户补充导入」/「跳过该依赖并标记」 |

建议默认：ID 冲突提示用户；状态覆盖提供「完全替换」与「按维度合并」两种模式；依赖缺失优先「提示补充」，必要时创建占位并标记。

#### 3.5.2 跨剧情复用适配

- **人物**：导入到 B 剧情时，若 B 中不存在该人物原势力，可配置「默认归为中立」或「提示用户指定新势力」；关系网中若涉及未导入角色，可置为「未建立」或按默认值。
- **场景**：若 B 剧情已有同 ID 场景，可配置「保留 B 当前状态」/「用 A 的状态覆盖」/「提示用户选择」；若时间线/氛围冲突，建议提示用户选择或保留 B 基础状态。

---

### 3.6 贴合度评估的量化（对应评审§3.1）

- **维度与权重（可配置）**：人物状态（关系/能力/修养/性格）x%、人物视野与判断 x%、环境状态 x%、情节走向 x%、主题一致性 x%；权重和为 100%，默认可设为人物 40%、视野 20%、情节 25%、环境 10%、主题 5%。
- **评分规则示例**：
  - 对话语气/立场：完全一致 10、风格一致措辞不同 8、立场相反 0；可插值。
  - 视野泄密：出现「不该知道的秘密」可一票否决或扣大分（如 -20）；按条扣分也可配置。
  - 情节走向：关键分支一致 满分，部分一致 按比例，完全偏离 0。
- **结果展示**：总评 + 分维度得分 + 「差异点说明」列表（如「该节点角色 A 知晓了原作未接触的信息 ID：xxx」），便于迭代。

---

### 3.7 异常场景处理（对应评审§五）

| 异常 | 处理策略 |
|------|----------|
| **多 Agent 行为冲突**（如 A 离开、B 挽留） | 定义优先级：用户输入驱动的行为 > 关键剧情角色 > 其他；或按「先提交先执行」+ 后执行者收到「前序结果」再决策；可配置 |
| **剧情死胡同**（无分支、无可用交互） | 兜底：提示「当前无推进路径，请调整输入」；可选「自动触发预设支线/求助」 |
| **原剧情锚点缺失** | 评估时该节点「跳过该维度」或「该维度按默认分（如 0 或中性分）」；在报告中标注「无锚点」 |
| **状态/快照损坏** | 加载失败时回滚到「最近一次正常快照」并提示；可选校验和/版本校验防止静默损坏 |

---

### 3.8 性能与存储（对应评审§4.1）

- **响应时间**：单角色场景 ≤ 2s，多角色（5+）≤ 5s（可调）；超时返回「处理中」或降级提示。
- **并发**：Phase 1 可单用户单剧情；多用户/多分支时，按「会话 ID」隔离，状态存储按会话分区。
- **存储**：单条剧情分支的状态数据建议上限（如人物数 × 状态大小、事件链长度）；快照数量上限可配置（如每分支最近 50 个），超限归档或提示清理。

---

## 四、数据模型概要

### 4.1 核心实体

- **Character**：id, 人设配置引用, 当前状态（关系/能力/修养/性格/已知信息 ID 列表）, 所属势力 ID 等。
- **WorldState**：当前场景 ID、时间线、环境状态（物理/社会/氛围）、事件链（事件 ID 列表）、当前情节节点 ID。
- **Information**：id, 内容或引用, 来源类型, 时间, 场景 ID, 关联事件 ID；是否关键记忆。
- **Anchor**：节点 ID, 剧情线 ID, 各人物反应与已知信息、环境与情节、主题；版本与来源。
- **Storyline / Plot**：情节线 ID, 节点列表, 分支定义, 依赖的人物/场景/主题 ID。
- **ExportPackage**：元数据（版本、依赖 ID 列表）、人物/环境/情节/主题的序列化块；类型（模板/快照）。

### 4.2 关键关系

- 人物 ↔ 人物：关系（多维度数值）。
- 人物 ↔ Information：已知信息 ID 集合（含获取时间）。
- 事件 ↔ 场景 / 人物：发生地、参与角色、产生的信息 ID。
- 锚点 ↔ 节点、人物、环境、情节、主题：多对一引用。

---

## 五、关键流程

### 5.1 用户输入推进剧情

1. 用户输入 → **Input Parser** 分类与意图解析 → 权限校验。
2. 合法意图 → **Story Orchestrator**：若为对话型，写入「用户对某角色说的话」；若为指令/场景型，生成对应事件或环境变更。
3. **World Engine** 更新环境/情节状态；**Vision Manager** 根据事件与规则，更新相关人物的「已知信息」；**Character State** 根据配置的触发表更新人物状态。
4. **Character Agent**（单人或多人）：Orchestrator 按当前场景取「在场角色」，对每人由 Vision Manager 提供「该人物视野」，Agent 输出对话/行动。
5. 若多 Agent 冲突，Orchestrator 按优先级或规则裁决，再写回世界状态与人物状态。
6. 返回本轮剧情结果（对话、状态变化摘要）给表现层；可选自动或用户触发快照。

### 5.2 对比与评估

1. 用户选择「当前分支」与「锚点剧情线/节点」。
2. **Anchor & Evaluation** 加载锚点与当前分支在该节点的状态（人物、环境、情节、主题）。
3. 按配置的维度与权重计算各维度得分与总评；生成「差异点说明」列表。
4. 输出报告（总评 + 分维度 + 差异列表）；可导出为文件或展示在界面。

### 5.3 导出与导入

1. **导出**：用户选择对象（人物/场景/情节线/…）与类型（模板/快照）；各领域模块序列化自身数据 → Export 组装包（含元数据与依赖 ID）→ 写入文件或存储。
2. **导入**：读取包 → 解析元数据与依赖 → **冲突检查**（ID/依赖）→ 若需用户选择则暂停并提示 → **适配规则**（跨剧情时人物/场景的默认处理）→ 写入库并返回结果（成功/部分成功/失败项列表）。

---

## 六、实施阶段与验收（对应评审§7）

### Phase 1

- **范围**：单场景、1～2 角色、简单世界状态；用户文字驱动；单节点原剧情对比；人物/环境具备 ID 与最小导出结构；人物具备关系/能力/修养/性格/视野等可演化维度，且行为仅读取该人物当前状态与视野。
- **验收标准**：① 1 个场景 + 2 个角色下「视野隔离」验证通过（某信息仅 A 知时，B 的回复不泄露）；② 人物/场景 JSON 导出包可成功导入并在新会话中加载；③ 用户指令型/对话型输入能正确解析并驱动一轮剧情；④ 状态演化至少 1 个关系维度可配置触发并生效。
- **依赖**：Vision Manager 信息过滤接口、Character State 存储与触发表加载、Input Parser 基础分类与权限校验。

### Phase 2

- **范围**：多角色、势力与关系、道具与剧情节点/分支、状态与环境快照、完整导出导入与冲突/适配、人物视野与判断对比。
- **验收标准**：① 多 Agent 冲突有明确裁决结果且无死锁；② 导入时 ID 冲突、依赖缺失至少一种策略可用且文档化；③ 人物状态快照导出后导入到另一剧情，该角色以快照状态参与；④ 对比报告含「人物视野与判断」维度及差异说明。
- **依赖**：Phase 1 验收通过；多 Agent 协调与冲突裁决实现；导出/导入冲突与适配策略实现；锚点必填字段落地。

### Phase 3

- **范围**：主题定义与主题一致性评估；贴合度多维度权重与评分规则可配置；势力/情节线/主题导出复用；演化约束与合理性规则；性能与存储上限、异常兜底、可视化与操作流程完善。
- **验收标准**：① 贴合度权重与评分规则可配置并生效；② 至少 1 条完整剧情线含锚点、对比报告可生成；③ 导出包含主题/情节线可导入并参与新剧情；④ 响应时间与存储上限符合设计指标。
- **依赖**：Phase 2 验收通过；评估量化配置与报告生成；主题与情节线导出格式稳定。

---

## 七、文档与变更

- 本文档与《需求文档》《需求评审1》保持一致；若需求或评审结论变更，应同步更新本概要设计。
- 详细接口定义、配置 JSON Schema、数据库表结构等可在后续《详细设计》或《接口说明》中展开。
