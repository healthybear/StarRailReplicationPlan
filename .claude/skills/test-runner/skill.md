---
name: test-runner
description: æ™ºèƒ½æµ‹è¯•æ‰§è¡Œä¸åˆ†æå™¨ï¼Œå¿«é€Ÿè¿è¡Œæµ‹è¯•å¹¶æä¾›ç²¾ç®€çš„ç»“æœæ‘˜è¦ï¼Œå¤§å¹…å‡å°‘tokenæ¶ˆè€—
version: 1.0.0
---

# æµ‹è¯•æ‰§è¡Œä¸åˆ†æå™¨

æ™ºèƒ½æµ‹è¯•æ‰§è¡Œå·¥å…·ï¼Œä¸“ä¸ºã€Šæ˜Ÿç©¹é“é“å‰§æƒ…å¤ç°è®¡åˆ’ã€‹é¡¹ç›®ä¼˜åŒ–ã€‚è‡ªåŠ¨è§£ææµ‹è¯•è¾“å‡ºï¼Œåªæ˜¾ç¤ºå…³é”®ä¿¡æ¯ï¼ŒèŠ‚çœ 80-90% çš„ token æ¶ˆè€—ã€‚

## åŠŸèƒ½

1. **æ™ºèƒ½æµ‹è¯•æ‰§è¡Œ** - æ”¯æŒå…¨éƒ¨/å•åŒ…/å•æ–‡ä»¶æµ‹è¯•
2. **ç»“æœç²¾ç®€** - åªæ˜¾ç¤ºå…³é”®ä¿¡æ¯ï¼ˆé€šè¿‡ç‡ã€å¤±è´¥ç”¨ä¾‹ã€è¦†ç›–ç‡ï¼‰
3. **è¦†ç›–ç‡åˆ†æ** - å¿«é€Ÿæ£€æŸ¥æ˜¯å¦è¾¾æ ‡ï¼ˆâ‰¥60%ï¼‰
4. **å¤±è´¥å®šä½** - è‡ªåŠ¨æå–å¤±è´¥æµ‹è¯•çš„é”™è¯¯ä¿¡æ¯
5. **å¯¹æ¯”åˆ†æ** - å¯¹æ¯”å‰åæµ‹è¯•ç»“æœå˜åŒ–

## ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œå…¨éƒ¨æµ‹è¯•

```bash
# æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# æ™ºèƒ½è§£æè¾“å‡ºï¼Œåªæå–ï¼š
# - æµ‹è¯•ç»Ÿè®¡ï¼ˆæ€»æ•°/é€šè¿‡/å¤±è´¥ï¼‰
# - å¤±è´¥ç”¨ä¾‹è¯¦æƒ…
# - è¦†ç›–ç‡æ‘˜è¦
```

### 2. è¿è¡Œå•ä¸ªåŒ…çš„æµ‹è¯•

```bash
# æµ‹è¯• infrastructure åŒ…
pnpm --filter @star-rail/infrastructure test

# æµ‹è¯• core åŒ…
pnpm --filter @star-rail/core test

# æµ‹è¯• types åŒ…
pnpm --filter @star-rail/types test
```

### 3. è¿è¡ŒæŒ‡å®šæ–‡ä»¶çš„æµ‹è¯•

```bash
# æµ‹è¯•ç‰¹å®šæ–‡ä»¶
pnpm --filter @star-rail/infrastructure test json-file-storage.test.ts

# ä½¿ç”¨ pattern åŒ¹é…
pnpm --filter @star-rail/core test --testPathPattern=behavior-engine
```

### 4. æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:coverage

# åªæŸ¥çœ‹è¦†ç›–ç‡æ‘˜è¦ï¼ˆä¸æ˜¾ç¤ºè¯¦ç»†è¡¨æ ¼ï¼‰
pnpm test:coverage | grep -A 20 "Coverage summary"
```

### 5. ç›‘å¬æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰

```bash
# æ³¨æ„ï¼šä¸è¦åœ¨ Claude Code ä¸­ä½¿ç”¨ watch æ¨¡å¼
# å»ºè®®ç”¨æˆ·åœ¨è‡ªå·±çš„ç»ˆç«¯ä¸­è¿è¡Œï¼š
# pnpm test --watch
```

## è¾“å‡ºè§£æç­–ç•¥

### æµ‹è¯•ç»“æœç²¾ç®€

**åŸå§‹è¾“å‡º**ï¼ˆ2000-5000 tokensï¼‰ï¼š

```
PASS packages/infrastructure/src/config/__tests__/config-loader.test.ts
  ConfigLoader
    loadYaml
      âœ“ should load and parse valid YAML file (15 ms)
      âœ“ should throw error for invalid YAML schema (8 ms)
      ...
    loadJson
      âœ“ should load and parse valid JSON file (12 ms)
      ...
```

**ç²¾ç®€è¾“å‡º**ï¼ˆ200-500 tokensï¼‰ï¼š

```
âœ… æµ‹è¯•é€šè¿‡
- æ€»æµ‹è¯•ï¼š227 ä¸ª
- é€šè¿‡ï¼š227 ä¸ª
- å¤±è´¥ï¼š0 ä¸ª
- é€šè¿‡ç‡ï¼š100%

ğŸ“Š è¦†ç›–ç‡
- Statements: 82.75% âœ…
- Branches: 61.80% âœ…
- Functions: 86.70% âœ…
- Lines: 83.52% âœ…
```

### å¤±è´¥æµ‹è¯•æå–

å½“æœ‰æµ‹è¯•å¤±è´¥æ—¶ï¼Œåªæå–ï¼š

1. å¤±è´¥çš„æµ‹è¯•åç§°
2. é”™è¯¯ç±»å‹
3. å…³é”®é”™è¯¯ä¿¡æ¯ï¼ˆå‰ 5 è¡Œï¼‰
4. æ–‡ä»¶ä½ç½®

```
âŒ æµ‹è¯•å¤±è´¥ï¼š2 ä¸ª

1. JsonFileStorage > saveSnapshot
   é”™è¯¯ï¼šExpected field 'id' but got 'snapshotId'
   ä½ç½®ï¼špackages/infrastructure/src/storage/__tests__/json-file-storage.test.ts:186

2. ConfigLoader > loadYaml
   é”™è¯¯ï¼šENOENT: no such file or directory
   ä½ç½®ï¼špackages/infrastructure/src/config/__tests__/config-loader.test.ts:67
```

### è¦†ç›–ç‡è¾¾æ ‡æ£€æŸ¥

è‡ªåŠ¨æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é¡¹ç›®è¦æ±‚ï¼ˆâ‰¥60%ï¼‰ï¼š

```
ğŸ“Š è¦†ç›–ç‡æ£€æŸ¥

Infrastructure åŒ…ï¼š
- Statements: 46.70% âš ï¸ (æœªè¾¾æ ‡ï¼Œç›®æ ‡ 60%)
- Branches: 35.29% âš ï¸ (æœªè¾¾æ ‡ï¼Œç›®æ ‡ 60%)
- Functions: 52.94% âš ï¸ (æœªè¾¾æ ‡ï¼Œç›®æ ‡ 60%)
- Lines: 47.36% âš ï¸ (æœªè¾¾æ ‡ï¼Œç›®æ ‡ 60%)

æœªè¦†ç›–æ¨¡å—ï¼š
- LLM Provider (0% è¦†ç›–)
- Logger (0% è¦†ç›–)
- Error Handler (0% è¦†ç›–)

Core åŒ…ï¼š
- Statements: 82.75% âœ…
- Branches: 61.80% âœ…
- Functions: 86.70% âœ…
- Lines: 83.52% âœ…
```

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

| å‘½ä»¤                                           | ç”¨é€”                   | é¢„æœŸè€—æ—¶ |
| ---------------------------------------------- | ---------------------- | -------- |
| `pnpm test`                                    | è¿è¡Œå…¨éƒ¨æµ‹è¯•           | 10-30s   |
| `pnpm test:coverage`                           | ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š         | 15-40s   |
| `pnpm --filter @star-rail/core test`           | æµ‹è¯• core åŒ…           | 5-15s    |
| `pnpm --filter @star-rail/infrastructure test` | æµ‹è¯• infrastructure åŒ… | 3-10s    |
| `pnpm test -- --bail`                          | é‡åˆ°å¤±è´¥ç«‹å³åœæ­¢       | å˜åŒ–     |
| `pnpm test -- --verbose`                       | æ˜¾ç¤ºè¯¦ç»†è¾“å‡º           | 10-30s   |

## æµ‹è¯•è¾“å‡ºå…³é”®æŒ‡æ ‡

### å¿…é¡»æå–çš„ä¿¡æ¯

1. **æµ‹è¯•ç»Ÿè®¡**
   - Test Suites: X passed, Y total
   - Tests: X passed, Y total
   - é€šè¿‡ç‡ç™¾åˆ†æ¯”

2. **å¤±è´¥æµ‹è¯•**ï¼ˆå¦‚æœæœ‰ï¼‰
   - æµ‹è¯•åç§°ï¼ˆå®Œæ•´è·¯å¾„ï¼‰
   - é”™è¯¯ç±»å‹
   - é”™è¯¯æ¶ˆæ¯ï¼ˆå‰ 5 è¡Œï¼‰
   - æ–‡ä»¶å’Œè¡Œå·

3. **è¦†ç›–ç‡æ‘˜è¦**
   - Statements: X%
   - Branches: X%
   - Functions: X%
   - Lines: X%

4. **æ‰§è¡Œæ—¶é—´**
   - Time: Xs

### å¯é€‰ä¿¡æ¯ï¼ˆæŒ‰éœ€æå–ï¼‰

- Snapshots: X passed, Y total
- æ…¢é€Ÿæµ‹è¯•è­¦å‘Šï¼ˆ>5sï¼‰
- å†…å­˜ä½¿ç”¨æƒ…å†µ

## æ™ºèƒ½åˆ†æ

### è‡ªåŠ¨åˆ¤æ–­æµ‹è¯•çŠ¶æ€

```typescript
// ä¼ªä»£ç é€»è¾‘
if (failedTests === 0 && coverage >= 60%) {
  return "âœ… æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œè¦†ç›–ç‡è¾¾æ ‡";
} else if (failedTests > 0) {
  return "âŒ æœ‰æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦ä¿®å¤";
} else if (coverage < 60%) {
  return "âš ï¸ æµ‹è¯•é€šè¿‡ä½†è¦†ç›–ç‡ä¸è¶³";
}
```

### æä¾›ä¿®å¤å»ºè®®

å½“æµ‹è¯•å¤±è´¥æ—¶ï¼Œæ ¹æ®é”™è¯¯ç±»å‹æä¾›å»ºè®®ï¼š

- **Schema æ ¡éªŒé”™è¯¯** â†’ æ£€æŸ¥æ•°æ®ç»“æ„æ˜¯å¦åŒ¹é… Schema å®šä¹‰
- **æ–‡ä»¶ä¸å­˜åœ¨** â†’ æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæµ‹è¯•ç¯å¢ƒè®¾ç½®
- **è¶…æ—¶é”™è¯¯** â†’ æ£€æŸ¥å¼‚æ­¥æ“ä½œå’Œ Promise å¤„ç†
- **ç±»å‹é”™è¯¯** â†’ æ£€æŸ¥ TypeScript ç±»å‹å®šä¹‰

## ä¸é¡¹ç›®éªŒæ”¶æ ‡å‡†å¯¹ç…§

### Phase 1 éªŒæ”¶æ ‡å‡†æ£€æŸ¥

è‡ªåŠ¨æ£€æŸ¥ 5 é¡¹éªŒæ”¶æ ‡å‡†å¯¹åº”çš„æµ‹è¯•ï¼š

1. **è§†é‡éš”ç¦»éªŒè¯** â†’ æ£€æŸ¥ `vision-manager.test.ts` ä¸­çš„éš”ç¦»æµ‹è¯•
2. **å‰§æƒ…æ¨è¿›å¯æ§** â†’ æ£€æŸ¥ `input-parser.test.ts` ä¸­çš„è§£ææµ‹è¯•
3. **å¯¼å‡º/å¯¼å…¥å¯ç”¨** â†’ æ£€æŸ¥ `export-import.test.ts` ä¸­çš„åºåˆ—åŒ–æµ‹è¯•
4. **å¯¹æ¯”ç»“æœå¯è§** â†’ æ£€æŸ¥ `anchor-manager.test.ts` ä¸­çš„å¯¹æ¯”æµ‹è¯•
5. **çŠ¶æ€æ¼”åŒ–å¯é…ç½®** â†’ æ£€æŸ¥ `trigger-engine.test.ts` ä¸­çš„è§¦å‘è¡¨æµ‹è¯•

```
âœ… éªŒæ”¶æ ‡å‡†æµ‹è¯•çŠ¶æ€

1. è§†é‡éš”ç¦»éªŒè¯ï¼šâœ… é€šè¿‡ (12/12 tests)
2. å‰§æƒ…æ¨è¿›å¯æ§ï¼šâœ… é€šè¿‡ (18/18 tests)
3. å¯¼å‡º/å¯¼å…¥å¯ç”¨ï¼šâœ… é€šè¿‡ (15/15 tests)
4. å¯¹æ¯”ç»“æœå¯è§ï¼šâœ… é€šè¿‡ (8/8 tests)
5. çŠ¶æ€æ¼”åŒ–å¯é…ç½®ï¼šâœ… é€šè¿‡ (22/22 tests)
```

## Token ä¼˜åŒ–æŠ€å·§

1. **åªæ˜¾ç¤ºæ‘˜è¦** - ä¸æ˜¾ç¤ºæ¯ä¸ªæµ‹è¯•çš„è¯¦ç»†è¾“å‡º
2. **å¤±è´¥ä¼˜å…ˆ** - æœ‰å¤±è´¥æ—¶åªæ˜¾ç¤ºå¤±è´¥ä¿¡æ¯
3. **è¦†ç›–ç‡ç²¾ç®€** - åªæ˜¾ç¤ºåŒ…çº§åˆ«æ±‡æ€»ï¼Œä¸æ˜¾ç¤ºæ–‡ä»¶çº§åˆ«
4. **ä½¿ç”¨è¡¨æ ¼** - ç”¨è¡¨æ ¼ä»£æ›¿é•¿æ–‡æœ¬
5. **ç¼“å­˜ç»“æœ** - è®°ä½ä¸Šæ¬¡æµ‹è¯•ç»“æœï¼Œåªæ˜¾ç¤ºå˜åŒ–

## ç¤ºä¾‹å¯¹è¯

**ç”¨æˆ·**: è¿è¡Œæ‰€æœ‰æµ‹è¯•

**å¤„ç†**:

```bash
# 1. æ‰§è¡Œæµ‹è¯•
pnpm test

# 2. è§£æè¾“å‡ºï¼Œæå–å…³é”®ä¿¡æ¯
# 3. ç”Ÿæˆç²¾ç®€æ‘˜è¦ï¼ˆ200-500 tokensï¼‰
```

**è¿”å›**:

```
âœ… æµ‹è¯•å…¨éƒ¨é€šè¿‡

ğŸ“Š ç»Ÿè®¡
- æ€»æµ‹è¯•ï¼š227 ä¸ª
- é€šè¿‡ç‡ï¼š100%
- æ‰§è¡Œæ—¶é—´ï¼š23.5s

ğŸ“ˆ è¦†ç›–ç‡
- Core: 82.75% âœ…
- Infrastructure: 46.70% âš ï¸

âš ï¸ Infrastructure åŒ…è¦†ç›–ç‡æœªè¾¾æ ‡ï¼ˆç›®æ ‡ 60%ï¼‰
æœªæµ‹è¯•æ¨¡å—ï¼šLLM Provider, Logger, Error Handler
```

---

**ç”¨æˆ·**: æµ‹è¯• infrastructure åŒ…

**å¤„ç†**:

```bash
pnpm --filter @star-rail/infrastructure test
```

**è¿”å›**:

```
âœ… Infrastructure åŒ…æµ‹è¯•é€šè¿‡

- æµ‹è¯•å¥—ä»¶ï¼š3 ä¸ª
- æµ‹è¯•ç”¨ä¾‹ï¼š34 ä¸ª
- é€šè¿‡ç‡ï¼š100%
- æ‰§è¡Œæ—¶é—´ï¼š8.2s

æµ‹è¯•æ–‡ä»¶ï¼š
- config-loader.test.ts (14 tests) âœ…
- json-file-storage.test.ts (20 tests) âœ…
```

---

**ç”¨æˆ·**: æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾æ ‡

**å¤„ç†**:

```bash
pnpm test:coverage | grep -A 30 "Coverage summary"
```

**è¿”å›**:

```
ğŸ“Š è¦†ç›–ç‡è¾¾æ ‡æ£€æŸ¥

âœ… Core åŒ…ï¼ˆè¾¾æ ‡ï¼‰
- Statements: 82.75% (ç›®æ ‡ 60%)
- Branches: 61.80% (ç›®æ ‡ 60%)
- Functions: 86.70% (ç›®æ ‡ 60%)
- Lines: 83.52% (ç›®æ ‡ 60%)

âš ï¸ Infrastructure åŒ…ï¼ˆæœªè¾¾æ ‡ï¼‰
- Statements: 46.70% (å·® 13.3%)
- Branches: 35.29% (å·® 24.71%)
- Functions: 52.94% (å·® 7.06%)
- Lines: 47.36% (å·® 12.64%)

å»ºè®®ï¼šä¸º LLM Providerã€Loggerã€Error Handler æ·»åŠ æµ‹è¯•
```

## æ³¨æ„äº‹é¡¹

1. **ä¸ä½¿ç”¨ watch æ¨¡å¼** - Claude Code ä¸æ”¯æŒé•¿æ—¶é—´è¿è¡Œçš„å‘½ä»¤
2. **è¶…æ—¶å¤„ç†** - æµ‹è¯•è¶…è¿‡ 2 åˆ†é’Ÿä¼šè‡ªåŠ¨ç»ˆæ­¢
3. **å¹¶å‘æµ‹è¯•** - é»˜è®¤ä½¿ç”¨ Jest çš„å¹¶å‘æ‰§è¡Œ
4. **å¿«ç…§æ›´æ–°** - éœ€è¦æ›´æ–°å¿«ç…§æ—¶ä½¿ç”¨ `pnpm test -- -u`

## æ›´æ–°æ—¥å¿—

- v1.0.0 (2026-02-18) - åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒæ™ºèƒ½æµ‹è¯•æ‰§è¡Œå’Œç»“æœåˆ†æ
